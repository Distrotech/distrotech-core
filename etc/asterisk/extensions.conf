;#    Copyright (C) 2002  <Gregory Hinton Nietsky>
;#    Copyright (C) 2005  <ZA Telecomunications>
;#
;#    This program is free software; you can redistribute it and/or modify
;#    it under the terms of the GNU General Public License as published by
;#    the Free Software Foundation; either version 2 of the License, or
;#    (at your option) any later version.
;#
;#    This program is distributed in the hope that it will be useful,
;#    but WITHOUT ANY WARRANTY; without even the implied warranty of
;#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;#    GNU General Public License for more details.
;#
;#    You should have received a copy of the GNU General Public License
;#    along with this program; if not, write to the Free Software
;#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

[general]
static=yes
writeprotect=no
autofallthrough=no
clearglobalvars=yes
priorityjumping=yes

[globals]
#include providers.conf
#include macros.conf
#include private.conf

[ivr-std]
exten => _XXXX,1,GotoIF(${EXISTS(${ODBC_SQL(name,users,name,${EXTEN})})}?intext,${EXTEN},1:i,1)
exten => i,1,Goto(autoattendant,prompt,invalid)
exten => d,1,Goto(autoattendant,oper,noivr)

[autoattendant]
exten => s-main,1,SET(DDIIVR=${IF(${EXISTS(${DDIORIGIN})}?${DDIORIGIN}:000)})
exten => s-main,n,SET(AADEL=${ODBC_RTDB(Setup,AADelay)})
exten => s-main,n,SET(AADEL=${IF(${EXISTS(${AADEL})}?${AADEL}:2)})
exten => s-main,n,SET(TIMEOUT(digit)=${AADEL})
exten => s-main,n,SET(TIMEOUT(response)=${MATH(${AADEL}*2,i)})
exten => s-main,n,SET(ARRAY(FMT1,FMT2,FMT3)="alaw,gsm,ulaw")
exten => s-main,n,SET(UEXTEN=)
exten => s-main,n,SET(ULPRE=)
exten => s-main,n,GoSubIf(${DIALPLAN_EXISTS(ivr-${DDIIVR}-local)}?ivr-${DDIIVR}-local,s,1)
exten => s-main,n,SET(IVRTYPE=ah)
exten => s-main,n,SET(FNUM=1)
exten => s-main,n,SET(SERVICETIME=${ODBC_TIME(${EDATA})})
exten => s-main,n,GotoIf(${EXISTS(${SERVICETIME})}?:afterhours)
exten => s-main,n,GotoIf($["${SERVICETIME}" = "1"]?officehours)
exten => s-main,n,GotoIf($["${SERVICETIME}" = "0"]?afterhours)
exten => s-main,n,GotoIf($["${SERVICETIME}" = "*"]?pubhol)
exten => s-main,n,GotoIfTime(${SERVICETIME},*,*,*?officehours)
exten => s-main,n(pubhol),SET(FNUM=3)
exten => s-main,n,GoSub(fstat,1)
exten => s-main,n,GotoIf(${FSTAT}?ivrok:afterhours)
exten => s-main,n+1(afterhours),SET(FNUM=2)
exten => s-main,n,GoSub(fstat,1)
exten => s-main,n,GotoIf(${FSTAT}?ivrok)
exten => s-main,n,Return
exten => s-main,n+1(officehours),SET(IVRTYPE=oh)
exten => s-main,n,GoSub(fstat,1)
exten => s-main,n,GotoIf(${FSTAT}?ivrok)
exten => s-main,n,Return

exten => s-main,n+1(ivrok),SET(PROMPT="${IF(${FSTATDEF}?"custom/000${FNUM}":"custom/${DDIIVR}${FNUM}")}")
exten => s-main,n,Goto(prompt,1)

exten => fstat,1,SET(FCNT=0)
exten => fstat,n,SET(FSTATDEF=0)
exten => fstat,n(next),SET(FCNT=${MATH(${FCNT}+1,i)})
exten => fstat,n,GotoIf($[!${EXISTS(${FMT${FCNT}})}]?end)
exten => fstat,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/${DDIIVR}${FNUM}.${FMT${FCNT}})}?end)
exten => fstat,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/000${FNUM}.${FMT${FCNT}})}?def)
exten => fstat,n,Goto(next)
exten => fstat,n+1(def),SET(FSTATDEF=1)
exten => fstat,n(end),SET(FSTAT=${EXISTS(${FMT${FCNT}})})
exten => fstat,n,Return

exten => prompt,1,GotoIf($[${CHANNEL(state)} = Up]?begin)
exten => prompt,n,Answer
exten => prompt,n(begin),SET(DEFIVR=${IF(${DIALPLAN_EXISTS(ivr-default)}?ivr-default:ivr-std)})
exten => prompt,n,SET(IVRCONT=${IF(${DIALPLAN_EXISTS(ivr-${DDIIVR})}?ivr-${DDIIVR}:${DEFIVR})})
exten => prompt,n,SET(IVRCONT=${IF(${DIALPLAN_EXISTS(ivr-${DDIIVR}-${IVRTYPE})}?ivr-${DDIIVR}-${IVRTYPE}:${IVRCONT})})
exten => prompt,n(play),Background(${PROMPT})
exten => prompt,n,PlayTones(ring)
exten => prompt,n+1(invalid),Playback(invalid)
exten => prompt,n,SET(UEXTEN=)
exten => prompt,n,SET(ULPRE=)
exten => prompt,n,Goto(play)
exten => prompt,n+1(wait),SET(UEXTEN=${NEWUEXTEN})
exten => prompt,n,WaitExten()

exten => oper,1,SET(AEXTEN=${ODBC_RTDB(Setup,Attendant)})
exten => oper,n,SET(AEXTEN=${IF(${EXISTS(${AEXTEN})}?${AEXTEN}:0)})
exten => oper,n,SET(CHANNEL(musicclass)=default)
exten => oper,n,GotoIf($[${AEXTEN} = 0 ]?auto:userout,${AEXTEN},1)
exten => oper,n+1(auto),SET(IVRTYPE=${IF(${EXISTS(${IVRTYPE})}?${IVRTYPE}:oh)})
exten => oper,n,GotoIf(${EXISTS(${AANOPROMPT})}?noivr)
exten => oper,n,SET(AANOPROMPT=${ODBC_RTDB(Setup,AANOPROMPT)})
exten => oper,n,SET(AANOPROMPT=${IF(${EXISTS(${AANOPROMPT})}?${AANOPROMPT}:0)})
exten => oper,n,GotoIf($[${AANOPROMPT} = 1]?noivr)
exten => oper,n,GotoIf(${EXISTS(${PROMPT})}?noivr)
exten => oper,n,SET(AADEL=${ODBC_RTDB(Setup,AADelay)})
exten => oper,n,SET(AADEL=${IF(${EXISTS(${AADEL})}?${AADEL}:2)})
exten => oper,n,SET(TIMEOUT(digit)=${AADEL})
exten => oper,n,SET(TIMEOUT(response)=${MATH(${AADEL}*2,i)})
exten => oper,n,SET(DDIIVR=std)
exten => oper,n,GotoIf($[${IVRTYPE} != oh]?ahivr)
exten => oper,n,SET(PROMPT=if-u-know-ext-dial&otherwise&hang-on-a-second&to-reach-operator)
exten => oper,n,Goto(prompt,1)
exten => oper,n+1(ahivr),SET(PROMPT=if-u-know-ext-dial)
exten => oper,n,Goto(prompt,1)
exten => oper,n+1(noivr),SET(AAOPTS=t)
exten => oper,n,SET(UEXTEN=)
exten => oper,n,SET(ULPRE=)
exten => oper,n,SET(ANext=${ODBC_RTDB(Setup,AANext)})
exten => oper,n,GotoIf($[${IVRTYPE} != oh]?t,timeout)
exten => oper,n,SET(AAMOH=${ODBC_RTDB(Setup,AAMOH)})
exten => oper,n,SET(AAMOH=${IF(${EXISTS(${AAMOH})}?${AAMOH}:0)})
exten => oper,n,SET(AATOUT=${ODBC_RTDB(Setup,AATimeout)})
exten => oper,n,SET(AATOUT=${IF(${EXISTS(${AATOUT})}?${AATOUT}:120)})
exten => oper,n,GotoIf($[${AAMOH} = 1]?anscall)
exten => oper,n,SET(AAOPTS=${AAOPTS}r)
exten => oper,n(runq),SET(GROUP(called)=799)
exten => oper,n,SET(AQUEUE=${ODBC_RTDB(Setup,AttendantQ)})
exten => oper,n,SET(AQUEUE=${IF(${EXISTS(${AQUEUE})}?${AQUEUE}:799)})
exten => oper,n,GotoIF($[${AQUEUE} < 0]?t,timeout)
exten => oper,n,StopPlayTones
;exten => oper,n,MusicOnHold
exten => oper,n,Queue(${AQUEUE},h${AAOPTS},,,${AATOUT},,queueconnect)
exten => oper,n,Goto(t,1)
exten => oper,n(anscall),GotoIf($[${CHANNEL(state)} = Up]?runq)
exten => oper,n,Answer
exten => oper,n,Goto(runq)

exten => _X,1,GotoIf(${EXISTS(${UEXTEN})}?add)
exten => _X,n,SET(UEXTEN=${EXTEN})
exten => _X,n,GotoIf($[!${DIALPLAN_EXISTS(${IVRCONT},${EXTEN}000)}]?test3)
exten => _X,n+1(test3),GotoIf($[!${DIALPLAN_EXISTS(${IVRCONT},${EXTEN}00)}]?test2)
exten => _X,n+1(test2),GotoIf($[!${DIALPLAN_EXISTS(${IVRCONT},${EXTEN}0)}]?check)
exten => _X,n+1(add),SET(UEXTEN=${UEXTEN}${EXTEN})
exten => _X,n,GotoIf(${EXISTS(${ULPRE})}?gotlp)
exten => _X,n,SET(ULPRE=${ODBC_RTDB(LocalPrefix,${UEXTEN:0:2})})
exten => _X,n,SET(ULPRE=${IF(${EXISTS(${ULPRE})}?${ULPRE}:0)})
exten => _X,n(gotlp),GotoIf($[!${DIALPLAN_EXISTS(${IVRCONT},${UEXTEN:0:2}00)} | !${ULPRE} | $[${LEN(${UEXTEN})} = 4]]?check)
exten => _X,n+1(check),GotoIf(${DIALPLAN_EXISTS(${IVRCONT},${UEXTEN})}?gotoivr)
exten => _X,n+1(gotoivr),SET(NEWUEXTEN=${UEXTEN})
exten => _X,n,SET(UEXTEN=)
exten => _X,n,SET(ULPRE=)
exten => _X,n,Goto(${IVRCONT},${NEWUEXTEN},1)

;on timeout
exten => t,1,StopPlayTones
exten => t,n,GotoIF(${EXISTS(${QUEUESTATUS})}?timeout:proceed)

;Queue Bombed
exten => t,n+1(timeout),GotoIf(${EXISTS(${EDATA})}?:nogrp)
exten => t,n,SET(GRROUTE=${ODBC_RTDB(BROUTE,${EDATA})})
exten => t,n,GotoIF(${EXISTS(${GRROUTE})}?userout,${GRROUTE},1)
exten => t,n(nogrp),GotoIf($[!${EXISTS(${ANext})}]?noanext)
exten => t,n,GotoIf($[${LEN(${ANext})} = 4}]?vmail:reroute)
exten => t,n(noanext),SET(ARRAY(FMT1,FMT2,FMT3)="alaw,gsm,ulaw")
exten => t,n,SET(FNUM=4)
exten => t,n,GoSub(fstat,1)
exten => t,n,GotoIf($[!${FSTAT}]?hangup)
exten => t,n,SET(FPROMPT=${IF(${FSTATDEF}?0004:${DDIIVR}4)})
exten => t,n,Playback(custom/${FPROMPT})
exten => t,n,Goto(hangup)

exten => t,n+1(vmail),GotoIf($[${IVRTYPE} = ah]?vmdel:reroute)
exten => t,n(vmdel),GotoIf($[${AANOPROMPT} = 1]?store)
exten => t,n,Background(pls-lv-msg-will-contact)
exten => t,n(store),Macro(vmaildel,${ANext},2)
exten => t,n(reroute),GotoIf($[${AANOPROMPT} = 1]?route)
exten => t,n,Background(nbdy-avail-to-take-call&pls-hold-while-try)
exten => t,n(route),SET(FWDCALL=1)
exten => t,n,SET(AACCESS=5)
exten => t,n,SET(ACCESSO=5)
exten => t,n,SET(AAREC=${ODBC_RTDB(Setup,AAREC)})
exten => t,n,SET(AAREC=${IF(${EXISTS(${AAREC})}?${AAREC}:0)})
exten => t,n,GotoIf(${AAREC}?:dialout)
exten => t,n,SET(CLOGID=${IF(${EXISTS(${DDIUNIQUEID})}?${DDIUNIQUEID}:${CDR(linkedid)})})
exten => t,n,SET(CALLLEG=${ODBC_LOGCOUNT(${CLOGID})})
exten => t,n,SET(ODBC_LOG(${CLOGID},${CALLLEG},${CHANNEL})=${ARG3})
exten => t,n,SET(CALLDATE=${IF(${EXISTS(${CALLDATE})}?${CALLDATE}:${STRFTIME(,,%Y-%m-%d)})}) 
exten => t,n,SET(MONITOR_EXEC_ARGS=${ODBC_RTDB(Setup,RecOpt)})
exten => t,n,Monitor(wav49,/var/spool/asterisk/monitor/${CALLDATE}/${ARG3}/${CLOGID}-${CALLLEG},mb)
exten => t,n(dialout),Goto(userout,${ANext},1)
;IVR Timeout
exten => t,n+1(proceed),GotoIf(${EXISTS(${UEXTEN})}?:default)
exten => t,n,SET(NEWUEXTEN=${UEXTEN})
exten => t,n,SET(UEXTEN=)
exten => t,n,SET(ULPRE=)
exten => t,n,GotoIf(${DIALPLAN_EXISTS(${IVRCONT},${NEWUEXTEN:0:1})}?${IVRCONT},${NEWUEXTEN:0:1},1)
exten => t,n,GotoIf(${DIALPLAN_EXISTS(${IVRCONT},i)}?${IVRCONT},i,1:prompt,invalid)
exten => t,n+1(default),GotoIf(${DIALPLAN_EXISTS(${IVRCONT},d)}?${IVRCONT},d,1)
exten => t,n,GotoIf($[!${EXISTS(${DDIORIGIN})}]?noddi)
exten => t,n(noddi),Return
exten => t,n+1(hangup),Hangup


;Replay
exten => *,1,Goto(prompt,1)

;Hangup
exten => _#,1,Hangup

exten => h,1,Hangup

exten => fax,1,Goto(fax,${DDIORIGN},1)

;IVR Menus
#include ivrmenu.conf

[busyline]
exten => 900,hint,Meetme:900
exten => 901,hint,Meetme:901
exten => 902,hint,Meetme:902
exten => 903,hint,Meetme:903
exten => 904,hint,Meetme:904
exten => 905,hint,Meetme:905
exten => 906,hint,Meetme:906
exten => 907,hint,Meetme:907
exten => 908,hint,Meetme:908
exten => 909,hint,Meetme:909
exten => 910,hint,Meetme:910
exten => 911,hint,Meetme:911
exten => 912,hint,Meetme:912
exten => 913,hint,Meetme:913
exten => 914,hint,Meetme:914
exten => 915,hint,Meetme:915
exten => 916,hint,Meetme:916
exten => 917,hint,Meetme:917
exten => 918,hint,Meetme:918
exten => 919,hint,Meetme:919
exten => 920,hint,Meetme:920
exten => 921,hint,Meetme:921
exten => 922,hint,Meetme:922
exten => 923,hint,Meetme:923
exten => 924,hint,Meetme:924
exten => 925,hint,Meetme:925
exten => 926,hint,Meetme:926
exten => 927,hint,Meetme:927
exten => 928,hint,Meetme:928
exten => 929,hint,Meetme:929
exten => 930,hint,Meetme:930
exten => 931,hint,Meetme:931
exten => 932,hint,Meetme:932
exten => 933,hint,Meetme:933
exten => 934,hint,Meetme:934
exten => 935,hint,Meetme:935
exten => 936,hint,Meetme:936
exten => 937,hint,Meetme:937
exten => 938,hint,Meetme:938
exten => 939,hint,Meetme:939
#include exten_blf.conf

[callback]
exten => _X.,1,SET(CDR(accountcode)=${CALLERID(num)})
exten => _X.,n,Goto(6,${EXTEN},1)

exten => _*X.,1,SET(ACCOUNT=${CUT(EXTEN,*,2)})
exten => _*X.,n,SET(NUMBER=${CUT(EXTEN,*,3)})
exten => _*X.,n,SET(CALLERID(number)=${ACCOUNT})
exten => _*X.,n,Set(TIMEOUT(digit)=6)
exten => _*X.,n,Set(TIMEOUT(response)=10)
exten => _*X.,n,Macro(getacc,${ACCOUNT})
exten => _*X.,n,Goto(userout,${NUMBER},1)

[6]
exten => _X.,1,SET(TRANSFER_CONTEXT=6)
exten => _X.,n,SET(TOUCH_MONITOR_FORMAT=wav49)
;exten => _X.,n,SET(GROUP(qagent)=free)
exten => _X.,n(qgrpfree),Macro(prepaycall,${EXTEN})
exten => _X.,n,StopMonitor()
exten => _X.,n,StopMixMonitor()
exten => _X.,n,GotoIf(${DIALPLAN_EXISTS(private,${EXTEN},1)}?private,${EXTEN},1)
exten => _X.,n,Goto(userout,${EXTEN},1)

exten => _X,1,SET(TRANSFER_CONTEXT=6)
exten => _X,n,SET(TOUCH_MONITOR_FORMAT=wav49)
exten => _X,n,Macro(prepaycall,${EXTEN})
exten => _X,n,StopMonitor()
exten => _X,n,StopMixMonitor()
exten => _X,n,Goto(userout,${EXTEN},1)

exten => _[a-zA-Z+*].,1,SET(TRANSFER_CONTEXT=6)
exten => _[a-zA-Z+*].,n,SET(TOUCH_MONITOR_FORMAT=wav49)
exten => _[a-zA-Z+*].,n,Macro(prepaycall,${EXTEN})
exten => _[a-zA-Z+*].,n,StopMonitor()
exten => _[a-zA-Z+*].,n,StopMixMonitor()
exten => _[a-zA-Z+*].,n,Goto(userout,${EXTEN},1)

exten => *,1,SET(TRANSFER_CONTEXT=6)
exten => *,n,SET(TOUCH_MONITOR_FORMAT=wav49)
exten => *,n,Macro(prepaycall,${EXTEN})
exten => *,n,StopMonitor()
exten => *,n,StopMixMonitor()
exten => *,n,Goto(userout,${EXTEN},1)

exten => s,1,DISA(no-password,6)

[userout]
;Voip Providers
include => providers

;Busy Line Indication
include => busyline

;PABX Hot Codes
include => private

;Free World Dial
include => fwdprivate

;Defaults
include => default

;Call Pickup
exten => *8,1,SET(TECH=${CUT(CHANNEL,/,1)})
exten => *8,n,SET(PICKUP_BRIDGE_MACRO=pickupfixup)
exten => *8,n,NoOp(${CDR(linkedid)})
exten => *8,n,SET(GROUP(pickup)=${IF($[${TECH} = DAHDI]?${ODBC_GETZAP(${CHANNEL})}:${CUT(CUT(CHANNEL,/,2),-,1)})})
exten => *8,n,Pickup()
exten => *8,n,SET(GROUP(qagent)=)
exten => *8,n,Hangup

exten => _*8X.,1,SET(TECH=${CUT(CHANNEL,/,1)})
exten => _*8X.,n,SET(PICKUP_BRIDGE_MACRO=pickupfixup)
exten => _*8X.,n,SET(GROUP(pickup)=${IF($[${TECH} = DAHDI]?${ODBC_GETZAP(${CHANNEL})}:${CUT(CUT(CHANNEL,/,2),-,1)})})
exten => _*8X.,n,Pickup(${EXTEN:2}@6)
exten => _*8X.,n,Hangup

;Log On As Agent
exten => _**,1,Goto(agents,${EXTEN},1)
exten => _***,1,Goto(agents,${EXTEN},1)

;Email Dialing (alpha)
exten => _[a-zA-Z].,1,SET(EFWD=${ODBC_EML(${EXTEN})})
exten => _[a-zA-Z].,n,GotoIf(${EXISTS(${EFWD})}?${EFWD},1:hangup)
exten => _[a-zA-Z].,n(hangup),Hangup()

;Internal Extension 2/3/4 digit dialing
;External Voip routing to 8/10 digit master server numbers (1X.)
exten => _XX,1,SET(DEFAULTPREFIX=${ODBC_RTDB(Setup,DefaultPrefix)})
exten => _XX,n,GotoIf(${EXISTS(${DEFAULTPREFIX})}?${DEFAULTPREFIX}${EXTEN},1)
;Set a regex for internal private 3 digit numbers
exten => _XXX,1,GotoIf(${DIALPLAN_EXISTS(private,${EXTEN})}?private,${EXTEN},1)
exten => _XXX,n,SET(DEFAULTPREFIX=${ODBC_RTDB(Setup,DefaultPrefix)})
exten => _XXX,n,GotoIf($[${DEFAULTPREFIX:1} != ${EXTEN:0:1}]?private,${EXTEN},1)
exten => _XXX,n,SET(UEXTEN=${DEFAULTPREFIX:0:1}${EXTEN})
exten => _XXX,n,SET(UNAME=${ODBC_SQL(name,users,name,${UEXTEN})})
;Dial the number as a premium telco if not aware of it
exten => _XXX,n,GotoIf(${EXISTS(${UNAME})}?${UEXTEN},1:telco,${EXTEN},1)

exten => _XXXX,1,SET(INTTELCO=${ODBC_RTDB(Setup,InternalPat)})
exten => _XXXX,n,SET(INTTELCO=${IF(${EXISTS(${INTTELCO})}?${INTTELCO}:(^$))})}
exten => _XXXX,n,GotoIf(${REGEX("${INTTELCO}" ${EXTEN})}?telco,${EXTEN},1)
exten => _XXXX,n,SET(DRING=${ODBC_RTDB(${EXTEN},DRING)})
exten => _XXXX,n,SET(DRING=${IF(${EXISTS(${DRING})}?${DRING}:1)})
exten => _XXXX,n,GotoIf($[[${DRING} = 0] | ${EXISTS(${DDIORIGIN})}]?nodring)
exten => _XXXX,n,SET(RING=${ODBC_CGRP(${EXTEN},${CALLERID(number)})})
exten => _XXXX,n,SET(RING=${IF(${EXISTS(${RING})}?${RING}:alert-internal)})
exten => _XXXX,n,SET(ALERTINF=${RING}) 
exten => _XXXX,n(nodring),SET(SDIAL=${ODBC_SQL(dest,speed_dial,number,${EXTEN})})
exten => _XXXX,n,GotoIf(${EXISTS(${SDIAL})}?userout,${SDIAL},1)
exten => _XXXX,n,Goto(intext,${EXTEN},1)

;E164 Calls
exten => _+.,1,SET(COUCODE=${ODBC_RTDB(Setup,CountryCode)})
exten => _+.,n,SET(COUCODE=${IF(${EXISTS(${COUCODE})}?${COUCODE}:27)})
exten => _+.,n,SET(INTACC=${ODBC_RTDB(Setup,IntAccess)})
exten => _+.,n,SET(INTACC=${IF(${EXISTS(${INTACC})}?${INTACC}:00)})
exten => _+.,n,SET(CCLEN=${LEN(${COUCODE})})
exten => _+.,n,GotoIf($[${EXTEN:1:${CCLEN}} != ${COUCODE}]?${INTACC}${EXTEN:1},1)
exten => _+.,n,SET(CCLEN=${MATH(${CCLEN}+1,i)})
exten => _+.,n,SET(LOCACC=${ODBC_RTDB(Setup,LocalAccess)})
exten => _+.,n,SET(LOCACC=${IF(${EXISTS(${LOCACC})}?${LOCACC}:0)})
exten => _+.,n,SET(DACODE=${ODBC_RTDB(Setup,DialAreaCode)})
exten => _+.,n,SET(DACODE=${IF(${EXISTS(${DACODE})}?${DACODE}:1)})
exten => _+.,n,GotoIf($[${DACODE} = 1]?natnum)
exten => _+.,n,SET(ACODE=${ODBC_RTDB(Setup,AreaCode)})
exten => _+.,n,SET(ACODE=${IF(${EXISTS(${ACODE})}?${ACODE}:011)})
exten => _+.,n,SET(NACODE=${ODBC_RTDB(Setup,NatAreaCode)})
exten => _+.,n,SET(NACODE=${IF(${EXISTS(${NACODE})}?${NACODE}:1)})
exten => _+.,n,GotoIf($[${NACODE} = 0]?notnat)
exten => _+.,n,SET(LACLEN=${LEN(${LOCACC})})
exten => _+.,n,SET(ACODE=${ACODE:${LACLEN}})
exten => _+.,n(notnat),SET(ACLEN=${LEN(${ACODE})})
exten => _+.,n,GotoIf($[${EXTEN:${CCLEN}:${ACLEN}} = ${ACODE}]?${EXTEN:${MATH(${CCLEN}+${ACLEN},i)}},1)
exten => _+.,n(natnum),Goto(${LOCACC}${EXTEN:${CCLEN}},1))

;Dynamic Routing
exten => _XXXX.,1,GotoIf(${EXISTS(${ODBC_SQL(name,users,name,${EXTEN})})}?:e164)
exten => _XXXX.,n,Macro(stdexten,${EXTEN},${CONTEXT})
exten => _XXXX.,n+1(e164),SET(EXLEN=${LEN(${EXTEN})})
exten => _XXXX.,n,SET(INTACC=${ODBC_RTDB(Setup,IntAccess)})
exten => _XXXX.,n,SET(INTACC=${IF(${EXISTS(${INTACC})}?${INTACC}:00)})
exten => _XXXX.,n,GotoIf(${REGEX("^${INTACC}" ${EXTEN})}?internat)
exten => _XXXX.,n,SET(NATLEN=${ODBC_RTDB(Setup,NatLength)})
exten => _XXXX.,n,SET(NATLEN=${IF(${EXISTS(${NATLEN})}?${NATLEN}:0)})
exten => _XXXX.,n,GotoIF($[$[${LEN(${EXTEN})} > ${NATLEN}] & $[${NATLEN} > 0]]?${EXTEN:0:${NATLEN}},short)
exten => _XXXX.,n(short),SET(TELCOP="${ODBC_RTDB(Setup,TPremiumPat)}")
exten => _XXXX.,n,GotoIf(${EXISTS(${TELCOP})}?:notpr)
exten => _XXXX.,n,GotoIf(${REGEX("${TELCOP}" ${EXTEN})}?tpremcall)
exten => _XXXX.,n(notpr),SET(PREPAT="${ODBC_RTDB(Setup,PremiumPat)}")
exten => _XXXX.,n,GotoIf(${EXISTS(${PREPAT})}?:nopr)
exten => _XXXX.,n,GotoIf(${REGEX("${PREPAT}" ${EXTEN})}?premcall)
exten => _XXXX.,n(nopr),SET(LOCALAREA=${ODBC_RTDB(LocalArea,${EXTEN:0:3})})
exten => _XXXX.,n,SET(LOCALAREA=${IF(${EXISTS(${LOCALAREA})}?${LOCALAREA}:0)})
exten => _XXXX.,n,SET(GSMPAT="${ODBC_RTDB(Setup,GSMPat)}")
exten => _XXXX.,n,GotoIf(${EXISTS(${GSMPAT})}?:nogsm)
exten => _XXXX.,n,GotoIf(${REGEX("${GSMPAT}" ${EXTEN})}?gsmcall)
exten => _XXXX.,n(nogsm),SET(LDPAT="${ODBC_RTDB(Setup,NationalPat)}");
exten => _XXXX.,n,GotoIf(${EXISTS(${LDPAT})}?:nold)
exten => _XXXX.,n,GotoIf(${REGEX("${LDPAT}" ${EXTEN})}?ldcall)
exten => _XXXX.,n(nold),SET(LOCPAT="${ODBC_RTDB(Setup,LocalPat)}");
exten => _XXXX.,n,GotoIf(${EXISTS(${LOCPAT})}?:noloc)
exten => _XXXX.,n,GotoIf(${REGEX("${LOCPAT}" ${EXTEN})}?loccall)
exten => _XXXX.,n(noloc),SET(TFPAT="${ODBC_RTDB(Setup,FreePat)}");
exten => _XXXX.,n,GotoIf(${EXISTS(${TFPAT})}?:notf)
exten => _XXXX.,n,GotoIf(${REGEX("${TFPAT}" ${EXTEN})}?tfcall)
exten => _XXXX.,n(notf),SET(VOIPPAT="${ODBC_RTDB(Setup,VoipPat)}");
exten => _XXXX.,n,GotoIf(${EXISTS(${VOIPPAT})}?:novoip)
exten => _XXXX.,n,GotoIf(${REGEX("${VOIPPAT}" ${EXTEN})}?voipcall)
exten => _XXXX.,n(novoip),SET(LOCACC=${ODBC_RTDB(Setup,LocalAccess)})
exten => _XXXX.,n,SET(LOCACC=${IF(${EXISTS(${LOCACC})}?${LOCACC}:0)})
exten => _XXXX.,n,GotoIf(${REGEX("^${LOCACC}" ${EXTEN})}?natout,${EXTEN},1)
exten => _XXXX.,n,SET(LOCLEN=${ODBC_RTDB(Setup,LocalLength)})
exten => _XXXX.,n,SET(LOCLEN=${IF(${EXISTS(${LOCLEN})}?${LOCLEN}:7)})
exten => _XXXX.,n,GotoIf($[${EXLEN} = ${LOCLEN}]?addac)
exten => _XXXX.,n,SET(SDIAL=${ODBC_SQL(dest,speed_dial,number,${EXTEN})})
exten => _XXXX.,n,GotoIf(${EXISTS(${SDIAL})}?userout,${SDIAL},1)
exten => _XXXX.,n,GotoIf($[${EXLEN} != 5]?unknown)
exten => _XXXX.,n,Macro(vroute,${EXTEN},1)
exten => _XXXX.,n+1(unknown),Goto(telco,${EXTEN},1))
exten => _XXXX.,n+1(voipcall),Goto(voip,${EXTEN},1)
exten => _XXXX.,n+1(internat),Macro(callout,${EXTEN},,${CALLERID(number)},5,5)
exten => _XXXX.,n+1(premcall),Macro(callout,${EXTEN},,${CALLERID(number)},4,4)
exten => _XXXX.,n+1(tpremcall),Goto(telco,${EXTEN},1)
exten => _XXXX.,n+1(gsmcall),Goto(gsmout,${EXTEN},1)

exten => _XXXX.,n+1(ldcall),Macro(callout,${EXTEN},,${CALLERID(number)},1,2)
exten => _XXXX.,n+1(loccall),Macro(callout,${EXTEN},,${CALLERID(number)},1,1)
exten => _XXXX.,n+1(tfcall),Macro(callout,${EXTEN},,${CALLERID(number)},0,0)
exten => _XXXX.,n+1(addac),SET(LACODE=${ODBC_RTDB(Setup,DialAreaCode)})
exten => _XXXX.,n,SET(LACODE=${IF(${EXISTS(${LACODE})}?${LACODE}:1)})
exten => _XXXX.,n,GotoIf(${LACODE}?:loccall)
exten => _XXXX.,n,SET(AREACODE=${ODBC_RTDB(Setup,AreaCode)})
exten => _XXXX.,n,SET(AREACODE=${IF(${EXISTS(${AREACODE})}?${AREACODE}:011)})
exten => _XXXX.,n,SET(NACODE=${ODBC_RTDB(Setup,NatAreaCode)})
exten => _XXXX.,n,SET(NACODE=${IF(${EXISTS(${NACODE})}?${NACODE}:1)})
exten => _XXXX.,n,GotoIf(${NACODE}?natout,${AREACODE}${EXTEN},1:natout,${LOCACC}${AREACODE}${EXTEN},1)
exten => _XXXX.,n,Goto(natout,${AREACODE}${EXTEN},1)

[telco]
exten => _X.,1,SET(TRUNK1=${ODBC_RTDB(Setup,Trunk)})
exten => _X.,n,SET(TPRE=${ODBC_RTDB(Setup,TrunkPre)})
exten => _X.,n,SET(TPRE=${IF(${EXISTS(${TPRE})}?${TPRE}:-)})
exten => _X.,n,SET(TSTRIP=${ODBC_RTDB(Setup,TrunkStrip)})
exten => _X.,n,SET(TSTRIP=${IF(${EXISTS(${TSTRIP})}?${TSTRIP}:0)})
exten => _X.,n,GotoIf($["${TPRE}" != "-"]?:nopre)
exten => _X.,n,SET(TRUNK1=${TRUNK1}${TPRE}${EXTEN:${TSTRIP}})
exten => _X.,n+1(nopre),SET(TRUNK1=${TRUNK1}${EXTEN:${TSTRIP}})
exten => _X.,n,SET(TCONT=${IF(${EXISTS(${TCONT})}?${TCONT}:4)})
exten => _X.,n,Macro(callout,${EXTEN:0:10},${TRUNK1},${CALLERID(number)},${TCONT},6)

[natout]
exten => _X.,1,GotoIF($[$[${LEN(${EXTEN})} < ${NATLEN}] & $[${NATLEN} > 0]]?badnum)
exten => _X.,n,SET(SITECODE=${ODBC_SITECODE()})
exten => _X.,n,GotoIf(${EXISTS(${SITECODE})}?:nosite)
exten => _X.,n,SET(LDDIST=${ODBC_RTDB(Setup,LDDist)})
exten => _X.,n,SET(LDDIST=${IF(${EXISTS(${LDDist})}?${LDDIST}:50)})
exten => _X.,n,GotoIf($[${LDDIST} = 0]?nosite)
exten => _X.,n,SET(CALLDIST=${ODBC_CALLDIST(${EXTEN},${SITECODE})})
exten => _X.,n,GotoIf(${EXISTS(${CALLDIST})}?:nosite)
exten => _X.,n,SET(DCONT=${IF($[${CALLDIST} <= ${LDDIST}]?1:2)})
exten => _X.,n,Macro(callout,${EXTEN},${AREAGW},${CALLERID(number)},1,${DCONT})
exten => _X.,n+1(nosite),SET(AREACODE=${ODBC_RTDB(Setup,AreaCode)})
exten => _X.,n,SET(AREACODE=${IF(${EXISTS(${AREACODE})}?${AREACODE}:011)})
exten => _X.,n,GotoIf($[${LOCALAREA} = 1]?local)
exten => _X.,n,GotoIf($[${EXTEN:0:3} = ${AREACODE}]?local)
exten => _X.,n,Macro(callout,${EXTEN},${AREAGW},${CALLERID(number)},1,2)
exten => _X.,n+1(local),Macro(callout,${EXTEN},${AREAGW},${CALLERID(number)},1,1)
exten => _X.,n+1(badnum),Answer
exten => _X.,n,Playtones(info)
exten => _X.,n,Wait(5)
exten => _X.,n,StopPlaytones
exten => _X.,n,Hangup

[gsmrouter]
exten => _X.,1,SET(GSMROUTE=${ODBC_RTDB(Setup,GSMRoute)})
exten => _X.,n,SET(GSMROUTE=${IF(${EXISTS(${GSMROUTE})}?${GSMROUTE}:0)})
exten => _X.,n,GotoIf($[! ${GSMROUTE}]?gateway)
exten => _X.,n,SET(GSMTRUNK=${ODBC_RTDB(Setup,GSMTrunk)})
exten => _X.,n,SET(MAXALL=${ODBC_RTDB(Setup,MaxAll)})
exten => _X.,n,SET(MAXALL=${IF(${EXISTS(${MAXALL})}?${MAXALL}:0)})
exten => _X.,n,SET(MAXANA=${ODBC_RTDB(Setup,MaxAna)})
exten => _X.,n,SET(MAXANA=${IF(${EXISTS(${MAXANA})}?${MAXANA}:1200000)})
exten => _X.,n,SET(MAXCALL=${IF(${MAXALL}?${MAXANA}:0)})
exten => _X.,n,Agi(agi://${AGISERVER}/cellroute.php?destination=${EXTEN}&router=${HOSTNAME}&maxcall=${MAXCALL})
exten => _X.,n,GoSubIf(${EXISTS(${GSMCHAN})}?c,1)

exten => _X.,n(gateway),SET(CELLGW=${ODBC_RTDB(Setup,CellGateway)})
exten => _X.,n,GotoIf(${EXISTS(${CELLGW})}?:failover)
exten => _X.,n,SET(GSMTRUNK=${ODBC_RTDB(Setup,GSMTrunk)})
exten => _X.,n(avchk),ChanIsAvail(${CELLGW:0:-1},j)
exten => _X.,n,SET(CELLGWCNT=${ODBC_RTDB(Setup,CellGatewayCnt)})
exten => _X.,n,SET(CELLGWCNT=${IF(${EXISTS(${CELLGWCNT})}?${CELLGWCNT}:0)})
exten => _X.,n,GotoIf($[$[${GROUP_COUNT(cellgw@out)} < ${CELLGWCNT}] | $[${CELLGWCNT} = 0]]?:nocellgw)
exten => _X.,n,SET(GROUP(out)=cellgw)
exten => _X.,n,SET(CELLGW=${CELLGW}${EXTEN})
exten => _X.,n,Return

exten => _X.,n+1(failover),SET(GSMTRUNK=${IF(${EXISTS(${GSMTRUNK})}?${GSMTRUNK}:1)})
exten => _X.,n,GotoIf(${GSMTRUNK}?:deny)
exten => _X.,n,SET(GFOPAT="${ODBC_RTDB(Setup,GSMFOPat)}");
exten => _X.,n,GotoIf(${EXISTS(${GFOPAT})}?:gsmtrunk)
exten => _X.,n,GotoIf(${REGEX("${GFOPAT}" ${EXTEN})}?gsmtrunk:deny)

exten => _X.,n+1(gsmtrunk),Return
exten => _X.,n+1(deny),Background(not-auth-pstn,n)

exten => _X.,n(return),Return
exten => _X.,avchk+101,Return

exten => c,1,SET(DIALSTATUS=${IF(${EXISTS(${DIALSTATUS})}?${DIALSTATUS}:CHANUNAVAIL)})
exten => c,n,SET(ODBC_GSMUP(${GSMCHAN},${GSMROUTER})=0)
exten => c,n,GotoIf($[${DIALSTATUS} != ANSWER]?callbad)
exten => c,n,SET(ANSWEREDTIME=${IF(${EXISTS(${ANSWEREDTIME})}?${ANSWEREDTIME}:0)})
exten => c,n,SET(ODBC_GSMOK(${GSMCHAN},${GSMROUTER})=${ANSWEREDTIME})
exten => c,n,SET(GSMCHAN=)
exten => c,n,Hangup
exten => c,n+1(callbad),SET(ODBC_GSMFAULT(${GSMCHAN},${GSMROUTER})=1)
exten => c,n,SET(ODBC_GSMFTO(${GSMCHAN},${GSMROUTER})=1)
exten => c,n,SET(GSMCHAN=)
exten => c,n,GotoIf($[${DIALSTATUS} = BUSY]:redial)
exten => c,n,Busy(5)
exten => c,n+1(redial),Return

exten => h,1,GoSubIf(${EXISTS(${GSMCHAN})}?c,1)
exten => h,n,Goto(default,h,1)

[gsmout]
exten => _X.,1,GotoIf($[${LOCALAREA} = 1]?dial)
exten => _X.,n,SET(LOCALAREA=3)
exten => _X.,n(dial),Macro(callout,${EXTEN},,${CALLERID(number)},${LOCALAREA},${LOCALAREA})

[voip]
;Master Server
exten => _XXXXXXXX,1,SET(SERVMODE=${ODBC_RTDB(Setup,Mode)})
exten => _XXXXXXXX,n,SET(SERVMODE=${IF(${EXISTS(${SERVMODE})}?${SERVMODE}:0)})
exten => _XXXXXXXX,n,GotoIf($[${SERVMODE} = 1]?ibvdial)
exten => _XXXXXXXX,n,Macro(vroute,${EXTEN},1)

exten => _XXXXXXXX,n(ibvdial),Macro(stdexten,${EXTEN},${CONTEXT})

;Voip Calls (Company Routing)
exten => _1XXXXXXXXX,1,SET(SERVMODE=${ODBC_RTDB(Setup,Mode)})
exten => _1XXXXXXXXX,n,SET(SERVMODE=${IF(${EXISTS(${SERVMODE})}?${SERVMODE}:0)})
exten => _1XXXXXXXXX,n,GotoIf($[${SERVMODE} = 0]?rroute)

exten => _1XXXXXXXXX,n,SET(VUSER=${ODBC_RTDB(${EXTEN:1:5},${EXTEN:6:2})})
exten => _1XXXXXXXXX,n,SET(ALIAS=${ODBC_RTDB(${EXTEN:1:5},ALIAS${EXTEN:6:2})})
exten => _1XXXXXXXXX,n,SET(ALIAS=${IF(${EXISTS(${ALIAS})}?${ALIAS}:${EXTEN:6:2})})
exten => _1XXXXXXXXX,n,SET(DTMF=${ODBC_RTDB(${EXTEN:1:5},DTMF${EXTEN:6:2})})
exten => _1XXXXXXXXX,n,SET(DTMF=${IF(${EXISTS(${DTMF})}?${DTMF}:${EXTEN:6:2})})
exten => _1XXXXXXXXX,n,Macro(ibdial,${VUSER},${ALIAS}${EXTEN:8},${DTMF})

exten => _1XXXXXXXXX,n(rroute),SET(CDR(accountcode)=${CALLERID(number)})
exten => _1XXXXXXXXX,n,SET(CDR(userfield)=${EXTEN:6})
exten => _1XXXXXXXXX,n,Macro(vroute,${EXTEN},1)


[agents]
exten => _**,1,SET(AGENTNUM=${CALLERID(number)})
exten => _**,n,SET(ODBC_AGENTON(Agent/${AGENTNUM})=1)
exten => _**,n,AgentLogin(${AGENTNUM})

exten => _***,1,Answer
exten => _***,n,Playback(please-enter-your)
exten => _***,n,Playback(extension)
exten => _***,n,Read(AGENTNUM,then-press-pound)
exten => _***,n,Macro(authuser,${AGENTNUM})
exten => _***,n,SET(AGENTNUM=${IF($[${AGENTNUM} != ${NEWUSER}]?${NEWUSER}:${AGENTNUM})})
exten => _***,n,SET(ODBC_AGENTON(Agent/${AGENTNUM})=1)
exten => _***,n,AgentLogin(${AGENTNUM})

exten => _X.,1,Goto(userout,${EXTEN},1)

exten => h,1,SET(ODBC_AGENTOFF(Agent/${AGENTNUM})=0)

[sugarcrm]
exten => _XXXX,1,Goto(intext,${EXTEN},local)

[clickcall]
exten => _XXXX,1,SET(ODBC_CLICK(${UNIQUEID})=${CLICKID})
exten => _XXXX,n,Goto(intext,${EXTEN},local)


[intext]
include => busyline
include => default

;IVR Digit Collection Routine [FWD]
exten => _X,1,SET(VMCONT=${IF(${EXISTS({VMCONT})}?${VMCONT}:0)})
exten => _X,n,GotoIf(${VMCONT}?macro-vmaildel,${EXTEN},1)

;All User SIP Extentions 01-98 [0-IVR 1-Vmail]
exten => _XXXX,1,SET(DDIEXTEN=${EXTEN})
exten => _XXXX,n,GotoIf(${EXISTS(${CALLERID(num)})}?:isqueue)
exten => _XXXX,n,SET(SIPREFER=${IF($[${CUT(CHANNEL,/,1)} = SIP]?1:0)})
exten => _XXXX,n,GotoIf(${SIPREFER}?:lvmail)
exten => _XXXX,n,SET(SIPREFER=${IF($["${SIP_HEADER(subject)}" = "click2dial call"]?1:0)})
exten => _XXXX,n(lvmail),GotoIf($[["${CALLERID(num)}" != "${EXTEN}"] | ${SIPREFER} | ${EXISTS(${DDIORIGIN})}]?:private,100,1)
exten => _XXXX,n(isqueue),SET(ACDPREFIX=${ODBC_RTDB(ACDPrefix,${EXTEN:0:2})})
exten => _XXXX,n,SET(ACDPREFIX=${IF(${EXISTS(${ACDPREFIX})}?${ACDPREFIX}:0)})
exten => _XXXX,n,GotoIf(${ACDPREFIX}?:islocal)
exten => _XXXX,n,Macro(callqueue,${EXTEN})
exten => _XXXX,n(islocal),SET(LOCALXPREFIX=${ODBC_RTDB(LocalPrefix,${EXTEN:0:2})})
exten => _XXXX,n,SET(LOCALXPREFIX=${IF(${EXISTS(${LOCALXPREFIX})}?${LOCALXPREFIX}:0)})
exten => _XXXX,n,GotoIf($[${LOCALXPREFIX} = 1]?:remote)
exten => _XXXX,n,SET(GTALKFWD=${ODBC_RTDB(GTALK,${EXTEN})})
exten => _XXXX,n,GotoIf(${EXISTS(${GTALKFWD})}?gtalk)
exten => _XXXX,n,SET(CDR(accountcode)=${CALLERID(number)})
exten => _XXXX,n,SET(CDR(userfield)=${EXTEN})
exten => _XXXX,n,SET(VUSER=${ODBC_SQL(name,users,name,${EXTEN})})
exten => _XXXX,n,GotoIf(${EXISTS(${VUSER})}?udial)
exten => _XXXX,n,SET(REMFWDD=${ODBC_RTDB(Setup,REMDEF)})
exten => _XXXX,n,SET(REMFWDD=${IF(${EXISTS(${REMFWDD})}?${REMFWDD}:0)})
exten => _XXXX,n,GotoIf(${REMFWDD}?remfwdcall)
exten => _XXXX,n,Gotoif($[${EXTEN:2} = 0]?atten)
exten => _XXXX,n,Gotoif($[${EXTEN:2} = 98]?echo)
exten => _XXXX,n,Gotoif($[${EXTEN:2} = 99]?vmail)
exten => _XXXX,n(udial),Macro(stdexten,${EXTEN},${CONTEXT})

exten => _XXXX,n+1(remote),SET(H323PREFIX=${ODBC_RTDB(H323Prefix,${EXTEN:0:2})})
exten => _XXXX,n,GotoIf(${EXISTS(${H323PREFIX})}?:rdial)
exten => _XXXX,n,GotoIf($[${H323PREFIX} = 1]?h323)
exten => _XXXX,n(rdial),SET(DEFBR=${ODBC_RTDB(Setup,Route)})
exten => _XXXX,n,GotoIf(${EXISTS(${DEFBR})}?droute:route)
exten => _XXXX,n(droute),Macro(callout,${EXTEN},SIP/${EXTEN}@${DEFBR}&IAX2/${DEFBR}@${DEFBR}/${EXTEN},${CALLERID(number)},0,10)
exten => _XXXX,n,Goto(s-${DIALSTATUS},1)

exten => _XXXX,n+1(route),SET(ALIAS=${ODBC_RTDB(LocalRewrite,${EXTEN:0:2})})
exten => _XXXX,n,SET(PROTO=${ODBC_RTDB(LocalRouteProto,${EXTEN:0:2})})
exten => _XXXX,n,GotoIF(${EXISTS(${PROTO})}?:noroute)
exten => _XXXX,n,SET(DNUM=${IF(${EXISTS(${ALIAS})}?${ALIAS}${EXTEN:2}:${EXTEN})})
exten => _XXXX,n,SET(LIBHOST=${ODBC_RTDB(LocalRoute,${EXTEN:0:2})})
exten => _XXXX,n,GotoIF($[${PROTO} = IAX2]?iaxib)
exten => _XXXX,n,GotoIF($[${PROTO} = SIP]?sipib)
exten => _XXXX,n,GotoIF($[${PROTO} = H323]?h323ib)
exten => _XXXX,n,GotoIF($[${PROTO} = OOH323]?h323ib)
exten => _XXXX,n+1(iaxib),Dial(IAX2/guest@${LIBHOST}/${DNUM},120,WgT)
exten => _XXXX,n+1(sipib),Dial(SIP/${LIBHOST}/${DNUM},120,WgT)
exten => _XXXX,n+1(h323ib),SET(ZPRE=0000)
exten => _XXXX,n,SET(PLEN=${MATH(4-${LEN(${LIBHOST})},i)})
exten => _XXXX,n,Dial(OOH323/000${ZPRE:1:${PLEN}}${LIBHOST}${DNUM}),120,WgT)
exten => _XXXX,n+1(noroute),Congestion(5)

exten => _XXXX,n+1(remfwdcall),SET(INTTELCO=${ODBC_RTDB(Setup,InternalPat)})
exten => _XXXX,n,SET(INTTELCO=${IF(${EXISTS(${INTTELCO})}?${INTTELCO}:(^$))})}
exten => _XXXX,n,GotoIf(${REGEX("${INTTELCO}" ${EXTEN})}?userout,${EXTEN},1)
exten => _XXXX,n,SET(FTRUNK=${ODBC_RTDB(Setup,FTrunk)})
exten => _XXXX,n,SET(FTRUNK=${IF(${EXISTS(${FTRUNK})}?${FTRUNK}:NONE)})}
exten => _XXXX,n,GotoIf($["${FTRUNK}" = "NONE"]?noddifwd)
exten => _XXXX,n,SET(FWDNUM=${ODBC_FWDNUM(${EXTEN})})
exten => _XXXX,n,SET(FWDNUM=${IF(${EXISTS(${FWDNUM})}?${FWDNUM}:${EXTEN})})
exten => _XXXX,n,Macro(callout,${EXTEN},${FTRUNK}${FWDNUM},${CALLERID(number)},0,0)
exten => _XXXX,n+1(noddifwd),Answer
exten => _XXXX,n,Playtones(info)
exten => _XXXX,n,Wait(5)
exten => _XXXX,n,StopPlaytones
exten => _XXXX,n,Hangup

exten => _XXXX,n+1(atten),Macro(repdial,${CALLERID(number)},${EXTEN})
exten => _XXXX,n,Goto(autoattendant,oper,1)

exten => _XXXX,n+1(echo),Macro(repdial,${CALLERID(number)},${EXTEN})
exten => _XXXX,n,Playback(demo-echotest)
exten => _XXXX,n,Echo
exten => _XXXX,n,Playback(demo-echodone)
exten => _XXXX,n,Hangup

exten => _XXXX,n+1(vmail),Macro(repdial,${CALLERID(number)},${EXTEN})
exten => _XXXX,n,Macro(vmlogin)
exten => _XXXX,n,Macro(vmcol,${USER})
exten => _XXXX,n,Hangup

exten => _XXXX,n+1(h323),Macro(stdexten,${EXTEN},${CONTEXT})

exten => _XXXX,n+1(gtalk),Macro(gtalk,${GTALKFWD})

exten => _X!,1,GotoIf(${EXISTS(${ODBC_SQL(name,users,name,${EXTEN})})}?:t,1)
exten => _X!,n,Macro(stdexten,${EXTEN},${CONTEXT})

exten => t,1,Answer
exten => t,n,Playtones(info)
exten => t,n,Wait(5)
exten => t,n,StopPlaytones
exten => t,n,Hangup

exten => fax,1,Goto(fax,${IF(${EXISTS(${DDIEXTEN})}?${DDIEXTEN}:${DDIORIGIN})},1)

[h323]
exten => _X.,1,SET(CONTIN=${ODBC_SQL(context,users,name,${CALLER_H323ID})})
exten => _X!,n,GotoIf(${EXISTS(${CONTIN})}?${CONTIN},${EXTEN},1)
exten => _X!,n,GotoIf($["${CALLER_H323ID}" = "t38modem"]?hyla)
exten => _X!,n,SET(NEIGH=${ODBC_H323NEIGH(${CUT(CHANNEL,-,1):7})})
exten => _X!,n,GotoIf(${EXISTS(${NEIGH})}?6,${EXTEN},1)
exten => _X!,n,SET(DDIORIGIN=${EXTEN})
exten => _X!,n,Goto(ddi,${EXTEN},1)

exten => _X!,n+1(hyla),SET(FAXOPT(gateway)=yes)
exten => _X!,n,SET(OOH323(faxdetect)=no)
exten => _X!,n,SET(FDET=${OOH323(faxdetect)})
;exten => _X!,n,NoOp(caller_h323id ${OOH323(caller_h323id)} caller_dialeddigits ${OOH323(caller_dialeddigits)} caller_email ${OOH323(caller_email)} caller_url ${OOH323(caller_url)})
;exten => _X!,n,NoOp(callee_h323id ${OOH323(callee_h323id)} callee_dialeddigits ${OOH323(callee_dialeddigits)} callee_email ${OOH323(callee_email)} callee_url ${OOH323(callee_url)})
exten => _X!,n,SET(DDIORIGIN=${EXTEN})
exten => _X!,n,GotoIf($[${EXTEN} = 999]?faxtest,${EXTEN},1)
exten => _X!,n,GotoIf($[${EXTEN} = 990]?faxin,${EXTEN},1)
exten => _X!,n,GotoIf($[${EXTEN} = 0865740587]?telkom)
exten => _X!,n,Goto(6,${EXTEN},1)

exten => _X!,n+1(telkom),Dial(DAHDI/1/${EXTEN})

exten => s,1,Hangup
exten => t,1,Hangup

[disa]
exten => s,1,Disa(no-password)

exten => _X.,1,SET(CDR(accountcode)=${CALLERID(num)})
exten => _X.,n,Goto(6,${EXTEN},1)

exten => _X,1,SET(CDR(accountcode)=${CALLERID(num)})
exten => _X,n,Goto(6,${EXTEN},1)

exten => i,1,Goto(s,1)

[sipddi]
exten => _X.,1,Goto(ddi,${CUT(SIP_HEADER(to),@,1):5},1)
exten => s,1,Goto(ddi,${CUT(SIP_HEADER(to),@,1):5},1)  
exten => _[a-zA-Z].,1,Goto(ddi,${CUT(SIP_HEADER(to),@,1):5},1)

[ddi]
exten => _[a-zA-Z].,1,SET(EFWD=${ODBC_EML(${EXTEN})})
exten => _[a-zA-Z].,n,SET(_DDIUNIQUEID=${CDR(linkedid)})
exten => _[a-zA-Z].,n,SET(TOUCH_MONITOR_FORMAT=wav49)
exten => _[a-zA-Z].,n,GotoIf(${EXISTS(${EFWD})}?${EFWD},1)
exten => _[a-zA-Z].,n,GotoIf($[${EXTEN:0:1} = s]?:hangup)
exten => _[a-zA-Z].,n,GotoIf(${EXISTS(${CALLERID(DNID)})}?:${EXTEN:1},1)
exten => _[a-zA-Z].,n,GotoIf($[${EXTEN} = ${CALLERID(DNID)}]?${EXTEN:1},1:${CALLERID(DNID)}${EXTEN:1},1)
exten => _[a-zA-Z].,n+1(hangup),Hangup

include => private
include => default

exten => s,1,SET(TOUCH_MONITOR_FORMAT=wav49)
exten => s,n,SET(_DDIUNIQUEID=${CDR(linkedid)})
exten => s,n,GotoIf($[!${EXISTS(${CALLERID(DNID)})}]?nodnid)
exten => s,n,GotoIf($[${CALLERID(DNID)} != ${EXTEN}]?${CALLERID(DNID)},1)
exten => s,n(nodnid),SET(CALLBACK=${ODBC_CLIALTC(${CALLERID(num)})})
exten => s,n,SET(CBACK=${ODBC_RTDB(${CALLBACK},ALTCB)})
exten => s,n,SET(CBACK=${IF(${EXISTS(${CBACK})}?${CBACK}:0)})
exten => s,n,GotoIf(${CBACK}?:nocb)
exten => s,n,Macro(callback,${CALLBACK},${CALLERID(number)})
exten => s,n+1(nocb),SET(CHANDDI=${CUT(CHANNEL,-,1)})
exten => s,n,SET(CHANDDIT=${CUT(CHANDDI,/,1)})
exten => s,n,SET(CHANDDI=${CUT(CHANDDI,/,2)})
exten => s,n,SET(CHANDDI=${IF($[${CHANDDIT} = mISDN]?I${CHANDDI}:${IF($[${CHANDDIT} = DAHDI]?T${CHANDDI})})})
exten => s,n,SET(DDIFWD=${ODBC_RTDB(PDDI,${CHANDDI})})
exten => s,n,GotoIf(${EXISTS(${DDIFWD})}?ddi,${DDIFWD},1)
exten => s,n,SET(CALLERID(num)=${IF(${EXISTS(${CALLERID(num)})}?${CALLERID(num)}:Unknown)})
exten => s,n,SET(CALLERPRES(num-pres)=allowed)
exten => s,n,SET(CALLERPRES(name-pres)=allowed)
exten => s,n,Macro(callergrp,${CALLERID(num)})
exten => s,n,SET(DDIORIGIN=Unknown)
exten => s,n,SET(DISADDI=${ODBC_RTDB(Setup,DISADDI)})
exten => s,n,SET(DISADDI=${IF(${EXISTS(${DISADDI})}?"${DISADDI}":0)})
exten => s,n,GotoIf(${DISADDI}?disa)
exten => s,n,SET(ALERTINF=alert-external)
exten => s,n,GoSub(autoattendant,s-main,1)
exten => s,n,Goto(autoattendant,oper,1)
exten => s,n+1(disa),SET(CLINUM=${ODBC_CLIMAP(${CALLERID(number)})})
exten => s,n,SET(CDR(accountcode)="${IF(${EXISTS(${CLINUM})}?"${CLINUM}":"${CALLERID(number)}")}")
exten => s,n,Disa(no-password,userout)



exten => _X.,1,SET(CALLERID(num)=${IF(${EXISTS(${CALLERID(num)})}?${CALLERID(num)}:Unknown)})

exten => _X!,2,SET(CLIINF=${ODBC_CLIMAP(${CALLERID(num)})})
exten => _X!,n,SET(_DDIUNIQUEID=${CDR(linkedid)})
exten => _X!,n,SET(CALLERID(num)=${IF(${EXISTS(${CLIINF})}?${CLIINF}:${CALLERID(num)})})
exten => _X!,n,SET(CLIINF=${ODBC_SQL(fullname,users,name,${CALLERID(num)})})
exten => _X!,n,SET(CALLERID(name)=${IF(${EXISTS(${CLIINF})}?${CLIINF}:${CALLERID(name)})})
exten => _X!,n,SET(TOUCH_MONITOR_FORMAT=wav49)
exten => _X!,n(fwdback),SET(DDIORIGIN=${EXTEN})
exten => _X!,n,SET(CBACK=${ODBC_RTDB(${EXTEN},ALTCB)})
exten => _X!,n,SET(CBACK=${IF(${EXISTS(${CBACK})}?${CBACK}:0)})
exten => _X!,n,GotoIf(${CBACK}?:nocb)
exten => _X!,n,SET(CALLBACK=${ODBC_RTDB(${EXTEN},ALTC)})
exten => _X!,n,GotoIf(${EXISTS(${CALLBACK})}?:nocb)
exten => _X!,n,GotoIf($[${CALLBACK} = ${CALLERID(num)}]?:nocb)
exten => _X!,n,Macro(callback,${EXTEN},${CALLBACK})
exten => _X!,n+1(nocb),SET(EDATA=${ODBC_RTDB(${EXTEN},BGRP)})
;exten => _X!.n,SET(CLINAME=${ODBC_SQL(fullname,users,name,${CALLERID(num)})})


exten => _X!,n,SET(CALLERID(name)=${IF(${EXISTS(${CALLERID(name)})}?"${CALLERID(name)}":"${CALLERID(num)}")})
exten => _X!,n,SET(GRPADD=${ODBC_RTDB(Setup,AddGroup)})
exten => _X!,n,SET(GRPADD=${IF(${EXISTS(${GRPADD})}?${GRPADD}:1)})
exten => _X!,n,GotoIf(${GRPADD}?:setpres)
exten => _X!,n,SET(CALLERID(name)=${IF(${EXISTS(${EDATA})}?"${EDATA} ${CALLERID(name)}":"${CALLERID(name)}")})
exten => _X!,n(setpres),SET(CALLERPRES(num-pres)=allowed)
exten => _X!,n,SET(CALLERPRES(name-pres)=allowed)
exten => _X!,n,SET(DDIFWD=${ODBC_USERDDI(${EXTEN})})
exten => _X!,n,SET(DDIFWD=${IF(${EXISTS(${DDIFWD})}?${DDIFWD}:${ODBC_RTDB(DDI,${EXTEN})})})
exten => _X!,n,GotoIf($[!${EXISTS(${DDIFWD})}]?fwdddi)
exten => _X!,n,GotoIf(${DIALPLAN_EXISTS(ivrcb-${DDIORIGIN})}?ivrcb-${DDIORIGIN},${CALLERID(name)},1)
exten => _X!,n,GoSub(autoattendant,s-main,1)
;exten => _X!,n,Macro(callergrp,${CALLERID(num)},${DDIFWD})
exten => _X!,n,Goto(userout,${DDIFWD},1)
exten => _X!,n+1(fwdddi),SET(CHKDDI=${ODBC_RTDB(Setup,FollowDDI)})
exten => _X!,n,SET(CHKDDI=${IF(${EXISTS(${CHKDDI})}?${CHKDDI}:1)})
exten => _X!,n,SET(VUSER=${ODBC_SQL(name,users,name,${EXTEN})})
exten => _X!,n,GotoIf(${CHKDDI}?:nochkddi)
exten => _X!,n,GotoIF(${EXISTS(${VUSER})}?ddiint)
exten => _X!,n(nochkddi),SET(FWDNUM=${ODBC_FWDNUM(${EXTEN})})
exten => _X!,n,GotoIf(${EXISTS(${FWDNUM})}?${FWDNUM},fwdback)
exten => _X!,n,GotoIf(${EXISTS(${ODBC_RTDB(DDIFAX,${EXTEN})})}?:fwd)
exten => _X!,n,Answer
exten => _X!,n,Wait(4)
exten => _X!,n(fwd),SET(FTRUNK=${ODBC_RTDB(Setup,FTrunk)})
exten => _X!,n,SET(FTRUNK=${IF(${EXISTS(${FTRUNK})}?"${FTRUNK}":NONE)})
exten => _X!,n,GotoIf($["${FTRUNK}" = "NONE"]?nofwd)
exten => _X!,n,SET(FWDTLOC="${ODBC_RTDB(Setup,TRUNKDDIPat)}")
exten => _X!,n,SET(FWDTLOC="${IF({EXISTS(${FWDTLOC})}?"${FWDTLOC}":"(^0[1-8][0-9]{8}$)|(^1021[0-9]$)|(^1011[178]$)|(^00)")}")
exten => _X!,n,SET(ITELCO="${ODBC_RTDB(Setup,InternalPat)}")
exten => _X!,n,SET(ITELCO="${IF({EXISTS(${ITELCO})}?"${ITELCO}":"(^102)")}")
exten => _X!,n,GotoIf($[${REGEX("${FWDTLOC}" ${EXTEN})} | $[${REGEX("${ITELCO}" ${EXTEN})} & $[${LEN(${EXTEN})} = 4]]]?:nofwd)
exten => _X!,n,SET(CDR(accountcode)=${CALLERID(number)})
;exten => _X!,n,Macro(callergrp,${CALLERID(num)},${DDIFWD})
exten => _X!,n,Goto(userout,${EXTEN},1)
exten => _X!,n+1(nofwd),Goto(ddiint)

exten => _X!,n+1(ddiint),SET(DRING=${ODBC_RTDB(${EXTEN},DRING)})
exten => _X!,n,SET(DRING=${IF(${EXISTS(${DRING})}?${DRING}:0)})
exten => _X!,n,GotoIf($[${DRING} = 0]?nodring)
exten => _X!,n,SET(ALERTINF=alert-external)
exten => _X!,n(nodring),GoSub(autoattendant,s-main,1)
exten => _X!,n,GotoIf(${DIALPLAN_EXISTS(private,${EXTEN})}?private,${EXTEN},1)
exten => _X!,n,GotoIf(${DIALPLAN_EXISTS(default,${EXTEN})}?default,${EXTEN},1)
exten => _X!,n,GotoIf($[${EXISTS(${VUSER})} | $[${LEN(${EXTEN})} = 4]]?userout,${EXTEN},1)
exten => _X!,n,SET(DDIBLOCK="${ODBC_RTDB(Setup,DDIPAT)}")
exten => _X!,n,SET(DDIBLOCK="${IF({EXISTS(${DDIBLOCK})}?"${DDIBLOCK}":"^[0-9]+$")}")
exten => _X!,n,GotoIf(${REGEX("${DDIBLOCK}" ${EXTEN})}?autoattendant,oper,1:invalidddi)
exten => _X!,n+1(invalidddi),Congestion(5)

exten => *,1,Wait(2)
exten => *,n,Goto(autoattendant,oper,1)

exten => *8,1,SET(PUG=${CHANNEL(pickupgroup)})
exten => *8,n,SET(PUG=${IF(${EXISTS(${PUG})}?${PUG}:0)})
exten => *8,n,GotoIf($[${PUG} != 0]?pickup)
exten => *8,n,SET(CLIINF=${ODBC_CLIMAP(${CALLERID(num)})})
exten => *8,n,SET(CLIINF=${IF(${EXISTS(${CLIINF})}?${CLIINF}:${CALLERID(num)})})
exten => *8,n,SET(PUG=${ODBC_SQL(pickupgroup,users,name,${CLIINF})})
exten => *8,n,GotoIf(${EXISTS(${PUG})}?:hangup)
exten => *8,n,SET(CHANNEL(pickupgroup)=${PUG})
exten => *8,n(pickup),Goto(userout,*8,1)
exten => *8,n+1(hangup),Hangup

exten => fax,1,Goto(fax,${DDIORIGIN},1)

[default]
;timeout
exten => t,1,Answer
exten => t,n,Playtones(info)
exten => t,n,Wait(5)
exten => t,n,StopPlaytones
exten => t,n,Hangup

;hangup
exten => h,1,ResetCDR(w)
exten => h,n,NoCDR
exten => h,n,GoSubIf(${EXISTS(${TOUCH_MONITOR_OUTPUT})}?automon,s,1)
exten => h,n,GotoIf($[${FAXCALL}0 = 10]?fax)
;exten => h,n,SET(ANSWEREDTIME=${IF(${EXISTS(${ANSWEREDTIME})}?${ANSWEREDTIME}:0)})
;exten => h,n,SET(LOCALXPREFIX=${IF(${EXISTS(${LOCALXPREFIX})}?${LOCALXPREFIX}:0)})
;exten => h,n,GotoIf($[${LOCALXPREFIX} = 1]?write)
;exten => h,n(write),GotoIf($[${ANSWEREDTIME} = 0]?noop)
;exten => h,n,SET(ODBC_RTDB(${CALLERID(number)},LastCall)=${ANSWEREDTIME})
;exten => h,n(noop),NoOP
exten => h,n+1(fax),System(/var/lib/asterisk/scripts/mailfax "${CALLERID(number)}" "${DDIORIGIN}" "${EXTNAME}" "${EXTEMAIL}" "${FAXFILE}" "${EXTCOMPANY}") 

;incoming/Invalid Extension call
exten => s,1,Goto(9,1)
exten => i,1,GotoIF(${EXISTS(${FAXEXTEN})}?fax,fax,1)
exten => i,n,Goto(9,1)

;Reception User/Auto Attendant
exten => 0,1,Goto(autoattendant,oper,1)

exten => 9,1,Goto(autoattendant,oper,1)

;Auto Attendant
exten => *,1,Goto(autoattendant,oper,auto)

[fwdprivate]
;exten => 411,1,Macro(fwddial,${EXTEN},0)
;exten => 511,1,Macro(fwddial,${EXTEN},0)
;exten => 514,1,Macro(fwddial,${EXTEN},0)
;exten => 611,1,Macro(fwddial,${EXTEN},0)
;exten => 612,1,Macro(fwddial,${EXTEN},0)
;exten => 613,1,Macro(fwddial,${EXTEN},0)
;exten => 614,1,Macro(fwddial,${EXTEN},0)
;exten => 615,1,Macro(fwddial,${EXTEN},0)
;exten => 55555,1,Macro(fwddial,${EXTEN},0)

[providers]
;Free World Dial
;exten => _XXXXXX,1,Macro(fwddial,${EXTEN},9)
;exten => _XXXXX,1,Macro(fwddial,${EXTEN},99)

;iaxtel
exten => _1700[2-8]XXXXXX,1,Macro(iaxteldial,${EXTEN})
exten => _1888NXXXXXX,1,Macro(iaxteldial,${EXTEN})
exten => _1877NXXXXXX,1,Macro(iaxteldial,${EXTEN})
exten => _1866NXXXXXX,1,Macro(iaxteldial,${EXTEN})
exten => _1800NXXXXXX,1,Macro(iaxteldial,${EXTEN})

;firefly
exten => _0961XXXXXXXX,1,Macro(firefly,${EXTEN:4},0)
exten => 0961123,1,Macro(firefly,${EXTEN:4},0)

;free world dialup gateways
;exten => _17009XXXXXX,1,Macro(fwddial,${EXTEN:5},9)
;exten => _170099XXXXX,1,Macro(fwddial,${EXTEN:6},99)
;exten => _*18.,1,Macro(fwddial,${EXTEN},0)
;exten => _*31800.,1,Macro(fwddial,${EXTEN},0)
;exten => _*44800.,1,Macro(fwddial,${EXTEN},0)
;exten => _*44500.,1,Macro(fwddial,${EXTEN},0)
;exten => _*44808.,1,Macro(fwddial,${EXTEN},0)
;exten => _*47800.,1,Macro(fwddial,${EXTEN},0)
;exten => _*49800.,1,Macro(fwddial,${EXTEN},0)
;exten => _*49130.,1,Macro(fwddial,${EXTEN},0)
;exten => _*810120.,1,Macro(fwddial,${EXTEN},0)
;exten => _*1700.,1,Macro(fwddial,${EXTEN},0)
;exten => _**XXX,1,Macro(fwddial,${EXTEN},0)
;exten => _**XXX.,1,Macro(fwddial,${EXTEN},0)

[conferences]
exten => _9XX,1,Macro(confcall,${EXTEN})

[gsm]
exten => _475*.,1,Dial(Dahdi/${EXTEN:4}/111,,D(01))
exten => _475*.,n,Goto(${DIALSTATUS},1)
exten => _475*.,n,Hangup

exten => _*.,1,SET(ZCHAN=${CUT(EXTEN,*,2)})
exten => _*.,n,SET(NUMBER=${CUT(EXTEN,*,3)})
exten => _*.,n(dial),Dial(Dahdi/${ZCHAN}/${NUMBER},,gj)
;exten => _*.,n,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=f)
exten => _*.,n,Goto(${DIALSTATUS},1)
exten => _*.,n,Hangup


;exten => CHANUNAVAIL,1,SET(ODBC_SQL(outofservice,gsmchannels,channel,${ZCHAN})=1)
;exten => CHANUNAVAIL,n,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=t)

;exten => NOANSWER,1,SET(ODBC_SQL(outofservice,gsmchannels,channel,${ZCHAN})=1)
;exten => NOANSWER,n,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=t)

;exten => BUSY,1,SET(ODBC_SQL(outofservice,gsmchannels,channel,${ZCHAN})=1)
;exten => BUSY,1,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=f)

;exten => BUSY,1,SET(ODBC_SQL(outofservice,gsmchannels,channel,${ZCHAN})=1)
;exten => CANCEL,1,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=f)

;exten => CONGESTION,1,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=f)
;exten => DONTCALL,1,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=f)
;exten => TORTURE,1,SET(ODBC_SQL(inuse,gsmchannels,channel,${ZCHAN})=f)

;exten => _*.,dial+101,SET(ODBC_SQL(outofservice,gsmchannels,channel,${ZCHAN})=t)

exten => t,1,Hangup
exten => i,1,Hangup

[queues]
exten => _X.,1,SET(QNAME=${EXTEN})
exten => _X.,n,SET(QOHONLY=${ODBC_RTDB(Q${EXTEN},QOHONLY)})
exten => _X.,n,SET(QOHONLY=${IF(${EXISTS(${QOHONLY})}?${QOHONLY}:0)})
exten => _X.,n,SET(QVMFWD=${ODBC_RTDB(Q${EXTEN},QVMFWD)})
exten => _X.,n,SET(QVMFWD=${IF($[${QVMFWD} = NONE]?:${QVMFWD})})
exten => _X.,n,GotoIF(${QOHONLY}?:officehours)
exten => _X.,n,SET(SERVICETIME=${ODBC_TIME(${ODBC_RTDB(Q${EXTEN},BGRP)})})
exten => _X.,n,GotoIf(${EXISTS(${SERVICETIME})}?:afterhours)
exten => _X.,n,GotoIf($["${SERVICETIME}" = "1"]?officehours)
exten => _X.,n,GotoIf($["${SERVICETIME}" = "0"]?afterhours)
exten => _X.,n,GotoIf($["${SERVICETIME}" = "*"]?afterhours)
exten => _X.,n,GotoIfTime(${SERVICETIME},*,*,*?officehours)
exten => _X.,n(afterhours),GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/4${DDIORIGIN}.alaw)}?playnagnt)
exten => _X.,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/4${DDIORIGIN}.gsm)}?:noahprompt)
exten => _X,n(playnagnt),Read(CONT,custom/4${DDIORIGIN},1,,1,3)
exten => _X,n,GotoIf(${DIALPLAN_EXISTS(ivr-${QNAME},${CONT})}?ivr-${QNAME},${CONT},1)

exten => _X.,n(noahprompt),SET(QNOVMAIL=${ODBC_RTDB(Q${EXTEN},QNOVMAIL)})
exten => _X.,n,SET(QNOVMAIL=${IF(${EXISTS(${QNOVMAIL})}?${QNOVMAIL}:0)})
exten => _X.,n,GotoIF($[${EXISTS(${QVMFWD})} & ${QNOVMAIL}]?userout,${QVMFWD},1)
exten => _X.,n,GotoIF(${EXISTS(${QVMFWD})}?t,vmfwd)

exten => _X.,n+1(officehours),Macro(callqueue,${QNAME})

exten => t,1,GotoIF($[!${EXISTS(${QUEUESTATUS})}]?noagent)
exten => t,n,GotoIF($[${QUEUESTATUS} = TIMEOUT]?timeout:noagent)

exten => t,n(timeout),GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/3${DDIORIGIN}.alaw)}?playtout)
exten => t,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/3${DDIORIGIN}.gsm)}?:noprompt)
exten => t,n(playtout),Read(CONT,custom/3${DDIORIGIN},1,,1,3)
exten => t,n,GotoIf(${DIALPLAN_EXISTS(ivr-${QNAME},${CONT})}?ivr-${QNAME},${CONT},1:uinput)

exten => t,n+1(noprompt),GotoIF($[${QNOVMAIL} = 1]?noqvmail)
exten => t,n,GotoIF(${EXISTS(${QVMFWD})}?vmfwd)
exten => t,n,Read(CONT,hold-or-dial-0,1,,1,3)
exten => t,n,GotoIf(${DIALPLAN_EXISTS(ivr-${QNAME},${CONT})}?ivr-${QNAME},${CONT},1:uinput)

exten => t,n+1(uinput),GotoIF(${EXISTS(${CONT})}?:macro-callqueue,s,playagent)
exten => t,n,GotoIF($[${CONT} = 0]?:macro-callqueue,s,playagent)
exten => t,n,VoiceMail(${QNAME}@6)
exten => t,n,Goto(hangup)

exten => t,n+1(noagent),GotoIF($[${QNOVMAIL} = 1]?noqvmail)
exten => t,n,GotoIF(${EXISTS(${QVMFWD})}?vmfwd)
exten => t,n,Playback(nbdy-avail-to-take-call)
exten => t,n,VoiceMail(${QNAME}@6)
exten => t,n(hangup),Hangup

exten => t,n+1(vmfwd),Macro(vmaildel,${QVMFWD},0)
exten => t,n,Hangup

exten => t,n+1(noqvmail),SET(FWDCALL=1)
exten => t,n,SET(AACCESS=5)
exten => t,n,GotoIF(${EXISTS(${QVMFWD})}?userout,${QVMFWD},1)
exten => t,n,GotoIf(${DIALPLAN_EXISTS(ivr-${QNAME},${CONT})}?ivr-${QNAME},${CONT},1:uinput)
exten => t,n,Hangup

exten => h,1,Hangup

exten => i,1,Goto(t,1)

[fax]
exten => s,1,Gotoif(${EXISTS(${DDIORIGIN})}?fax,in:fax,out)

exten => fax,1,Gotoif(${EXISTS(${DDIORIGIN})}?fax,in:fax,out)

exten => fax,n+1(in),Goto(${DDIORIGIN},1)
exten => fax,n+1(out),Goto(${DDIORIGIN},1)

exten => Unknown,1,Answer
exten => Unknown,n,StopPlayTones
exten => Unknown,n,Goto(faxmail,${EXTEN},1)

exten => _X.,1,StopPlayTones
exten => _X.,n,SET(CFFAX=${ODBC_RTDB(${EXTEN},CFFAX)})
exten => _X.,n,SET(CFFAX=${IF(${EXISTS(${CFFAX})}?${CFFAX}:0)})
exten => _X.,n,GotoIf($[${CFFAX} != 0]?routefax)
exten => _X.,n,SET(FAXMAIL=${ODBC_RTDB(${EXTEN},FAXMAIL)})
exten => _X.,n,SET(FAXMAIL=${IF(${EXISTS(${DDIFAX})}?${DDIFAX}:${FAXMAIL})})
exten => _X.,n,SET(FAXMAIL=${IF(${EXISTS(${FAXMAIL})}?${FAXMAIL}:0)})
exten => _X.,n,GotoIf($[${FAXMAIL} != 0]?faxmail)
exten => _X.,n,GotoIf(${EXISTS(${EFAXD})}?gotefaxd)
exten => _X.,n,SET(EFAXD=${ODBC_RTDB(${EXTEN},EFAXD)})
exten => _X.,n,SET(EFAXD=${IF(${EXISTS(${EFAXD})}?${EFAXD}:0)})
exten => _X.,n(gotefaxd),GotoIf($[${EFAXD} > 0]?:fdetect)
exten => _X.,n,SET(FAXT=${ODBC_RTDB(Setup,FAXT)})
exten => _X.,n,GotoIf(${EXISTS(${FAXT})}?:faxmail)
exten => _X.,n,SET(FAXOPT(gateway)=yes)
exten => _X.,n,Goto(userout,${FAXT},1)
exten => _X.,n,Hangup

exten => _X.,n+1(routefax),SET(FAXOPT(gateway)=yes)
exten => _X.,n,GotoIF($[${LEN(${CFFAX})} > 4]?callout)
exten => _X.,n,Goto(userout,${CFFAX},1)
exten => _X.,n,Hangup

exten => _X.,n+1(callout),Macro(callout,${CFIM},,${ARG1},${ACCESS},${ACCESS})
exten => _X.,n,Hangup

exten => _X.,n+1(fdetect),SET(FAXOPT(gateway)=yes)
exten => _X.,n,Goto(userout,${DDIORIGIN},1)
exten => _X.,n,Hangup

exten => _X.,n+1(faxmail),Goto(faxmail,${EXTEN},1)

[automon]
exten => s,1,NoOp(${CDR(accountcode)})
exten => s,n,SET(email=${ODBC_SQL(email,users,name,${CUT(TOUCH_MONITOR_OUTPUT,-,3)})})
exten => s,n,GotoIf(${EXISTS(${email})}?:return)
exten => s,n,StopMonitor
exten => s,n,StopMixMonitor
exten => s,n,SET(MAILCMD=/usr/bin/wav2mail ${TOUCH_MONITOR_OUTPUT} ${CDR(src)} ${CDR(dst)} ${DOMAIN} ${email})
exten => s,n,System(${MAILCMD})
exten => s,n(return),Return

[faxmail]
exten => s,1,Macro(faxreceive,${EXTEN})
exten => _X.,1,Macro(faxreceive,${EXTEN})
exten => Unknown,1,Macro(faxreceive,${EXTEN})

exten => h,1,System(${MAILCMD})


[agent]

exten => _XXXX,1,SET(FTRUNK=${ODBC_RTDB(Setup,FTrunk)})
exten => _XXXX,n,SET(FTRUNK=${IF(${EXISTS(${FTRUNK})}?${FTRUNK}:NONE)})
exten => _XXXX,n,GotoIf($["${FTRUNK}" = "NONE"]?t,1)
exten => _XXXX,n,Dial(${FTRUNK}/${EXTEN})

exten => _XXXX.,1,Goto(userout,${EXTEN},1)

exten => t,1,Hangup

[ccdialin]
exten => _X.,1,SET(AGENTNUM=${ODBC_CCAGENT(${EXTEN})})
exten => _X.,n,SET(CDR(accountcode)=${AGENTNUM})
exten => _X.,n,Goto(userout,${AGENTNUM},1)

[ccddial]
exten => _X!,1,SET(CDR(userfield)=${EXTEN})
exten => _X!,n,SET(ACODE=${CUT(CHANNEL,@,1)})
exten => _X!,n,SET(ACODE=${CUT(ACODE,/,2)})
exten => _X!,n,SET(CDR(accountcode)=${ACODE})
exten => _X!,n,SET(ODBC_CCDCHAN(${ACODE})=${CDR(channel)})
exten => _X!,n,Dial(Local/${EXTEN}@cccall)

[ccdial]
;exten => _X!,1,SET(CCNUM=${ODBC_CCDIAL(${EXTEN})})
exten => _X!,1,SET(CCNUM=${CONTACT})
exten => _X!,n,SET(ODBC_CCDIAL(${EXTEN})=${CDR(uniqueid)})
exten => _X!,n,SET(ODBC_CCCHAN(${EXTEN})=${CDR(channel)})
exten => _X!,n,SET(CDR(userfield,l)=${CCNUM})
exten => _X!,n,SET(CDR(accountcode,l)=${ODBC_CCAGENT(${EXTEN})})
;exten => _X!,n,Goto(userout,${CCNUM},1)
exten => _X!,n,Dial(Local/${CCNUM}@cccall)

[cccall]
exten => _X.,1,SET(ODBC_CCDSTCHAN(${CDR(accountcode)})="${CDR(channel)}")
exten => _X.,n,Goto(userout,${EXTEN},1)

exten => _+.,1,SET(ODBC_CCDSTCHAN(${CDR(accountcode)})="${CDR(channel)}")
exten => _+.,n,Goto(userout,${EXTEN},1)


[ftrunkproxy]
exten => _X.,1,SET(UFTRUNK=${ODBC_RTDB(${EXTEN},FWDU)})
exten => _X.,n,SET(DFTRUNK=${ODBC_RTDB(Setup,FTrunk)})
exten => _X.,n,SET(UFTRUNK=${IF(${EXISTS(${UFTRUNK})}?"${UFTRUNK}":"${DFTRUNK}")})
exten => _X.,n,SET(UFTRUNK=${IF($["${UFTRUNK}" = "1"]?"${DFTRUNK}":"${UFTRUNK}")})
exten => _X.,n,SET(TOUT=${ODBC_RTDB(${EXTEN},TOUT)})
exten => _X.,n,SET(STOUT=${ODBC_RTDB(Setup,Timeout)})
exten => _X.,n,SET(STOUT=${IF(${EXISTS(${STOUT})}?${STOUT}:20)})
exten => _X.,n,SET(TOUT=${IF(${EXISTS(${TOUT})}?${TOUT}:${STOUT})})
exten => _X.,n,Dial(${UFTRUNK}${EXTEN},${TOUT},wgt)

[trunkproxy]
exten => _X.,1,SET(DOPT=${DB_DELETE(NOBRIDGE/${CDR(linkedid)})})
exten => _X.,n,SET(TIMEOUT(response)=1)
exten => _X.,n,Dial(${CUT(DOPT,:,1)},,${CUT(DOPT,:,2)})
