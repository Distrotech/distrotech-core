;#    Copyright (C) 2002  <Gregory Hinton Nietsky>
;#    Copyright (C) 2005  <ZA Telecomunications>
;#
;#    This program is free software; you can redistribute it and/or modify
;#    it under the terms of the GNU General Public License as published by
;#    the Free Software Foundation; either version 2 of the License, or
;#    (at your option) any later version.
;#
;#    This program is distributed in the hope that it will be useful,
;#    but WITHOUT ANY WARRANTY; without even the implied warranty of
;#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
;#    GNU General Public License for more details.
;#
;#    You should have received a copy of the GNU General Public License
;#    along with this program; if not, write to the Free Software
;#    Foundation, Inc., 59 Temple Place, Suite 330, Boston, MA  02111-1307  USA

[macro-fwddial]
exten => s,1,Macro(repdial,${CALLERID(number)},${ARG1})
exten => s,n,SET(NOCLID=${ODBC_FEATDB(${CALLERID(number)},NoCLID)})
exten => s,n,GotoIf(${EXISTS(${NOCLID})}?:cli)
exten => s,n,SET(CALLERID(all)=)
exten => s,n,SET(ODBC_FEATDB(${ARG1},NoCLID)=NULL)
exten => s,n,Goto(s,dial)
exten => s,n(cli),SET(CALLERID(number)=${FWDTELNUM})
exten => s,n(dial),Dial(SIP/${ARG1}@freeworlddialup,,WgT)
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s-ANSWER,1,SayDigits(${ANSWEREDTIME})
exten => s-ANSWER,n,Background(seconds)
exten => s-ANSWER,n,Background(goodbye)
exten => s-ANSWER,n,Hangup
exten => _s-.,1,GotoIf($[${ARG2} < 9]?hangup)
exten => _s-.,n,Dial(IAX2/iaxtel/1700${ARG2}${ARG1},WgT)
exten => _s-.,n(hangup),Hangup

[macro-ibdial]
exten => s,1,SET(ARRAY(CWAIT,CFBU)="${ODBC_FEATDB(${ARG1},"wait,cfbu")}")
exten => s,n,SET(ARG3=${IF(${EXISTS(${ARG3})}?${ARG3}:0)})
exten => s,n,SET(DOPTS=g)
exten => s,n,SET(IPROTO=${CUT(CHANNEL,/,1)})
exten => s,n,GotoIf($[${ARG3} = 1]?:cwait)
exten => s,n,SET(DOPTS=${DOPTS}D(${ARG2}))
exten => s,n(cwait),GotoIf(${EXISTS(${ARG1})}?:dial)
exten => s,n,GotoIF($[${CWAIT} = 1]?dial)
exten => s,n,GotoIf($[${GROUP_COUNT(${ARG1}@called)} >= 1]?:dial)
exten => s,n,GotoIf(${EXISTS(${CFBU})}?dial:hangup)
;check status again by re entering ibdial instead of dial ?? hunting

exten => s,n+1(dial),SET(ULINE=${IF(${EXISTS(${CFBU})}?${CFBU}:${ARG1})})
exten => s,n,SET(IAXLINE=${ODBC_FEATDB(${ULINE},IAXLine)})
exten => s,n,SET(IAXLINE=${IF(${EXISTS(${IAXLINE})}?${IAXLINE}:0)})
exten => s,n,SET(ARG2=${IF(${EXISTS(${ARG2})}?${ARG2}:${ULINE})})
exten => s,n,GotoIF($[${IAXLINE} = 1]?:crsip)
exten => s,n,GotoIF($[${IPROTO} = IAX2]?iaxdial)
exten => s,n(iaxdial),Dial(IAX2/guest@${ULINE}/${ARG2},,${DOPTS})

exten => s,n+1(crsip),GotoIF($[${IPROTO} = SIP]?sipdial)
exten => s,n(sipdial),GotoIF($["${ARG2:0:1}" = "*"]?nodefault)
exten => s,n,Dial(SIP/${ULINE}/${ARG2},,${DOPTS})
exten => s,n+1(nodefault),Dial(SIP/${ULINE},,${DOPTS})
exten => s,n+1(hangup),hangup

[macro-callthrough]
exten => s,1,Answer
exten => s,n,Set(TIMEOUT(digit)=4)
exten => s,n,Set(TIMEOUT(response)=10)
exten => s,n,Wait(2)
exten => s,n,PlayTones(dial)
exten => s,n,Read(FDIGIT,,1,3)
exten => s,n,StopPlayTones(dial)
exten => s,n,Read(NUMBER,,20)
exten => s,n,SET(SERVMODE=${ODBC_RTDB(Setup,Mode)})
exten => s,n,SET(SERVMODE=${IF(${EXISTS(${SERVMODE})}?${SERVMODE}:0)})
exten => s,n,GotoIf($[${SERVMODE} = 1]?master)
exten => s,n,Goto(userout,${FDIGIT}${NUMBER},1)
exten => s,n+1(master),SET(ACCOUNT=${ODBC_SQL(username,callerid,cid,${CALLERID(number)})})
exten => s,n,GotoIf(${EXISTS(${ACCOUNT})}?:hangup)
exten => s,n,AGI(agi://${AGISERVER}/prepaid.php?username=${ACCOUNT}&destination=${FDIGIT}${NUMBER})

[macro-callback]
exten => s,1,Set(TIMEOUT(digit)=4)
exten => s,n,Set(TIMEOUT(response)=10)
exten => s,n,SET(ACCOUNT=${ARG1})
exten => s,n,SET(CALLBACK=${ARG2})
exten => s,n,Congestion(5)

exten => h,1,AGI(agi://${AGISERVER}/callback.php?master=${AGISERVER}&account=${ACCOUNT}&callback=${CALLBACK})

[macro-vroute]
exten => s,1,SET(SERVMODE=${ODBC_RTDB(Setup,Mode)})
exten => s,n,SET(SERVMODE=${IF(${EXISTS(${SERVMODE})}?${SERVMODE}:0)})
exten => s,n,SET(CDOPTS=WgT)
exten => s,n,SET(MAXALL=${ODBC_RTDB(Setup,MaxAll)})
exten => s,n,SET(MAXALL=${IF(${EXISTS(${MAXALL})}?${MAXALL}:0)})
exten => s,n,GotoIf(${MAXALL}?:limited)
exten => s,n,SET(MAXANA=${ODBC_RTDB(Setup,MaxAna)})
exten => s,n,SET(MAXANA=${IF(${EXISTS(${MAXANA})}?${MAXANA}:1200000)})
exten => s,n,SET(CDOPTS=${CDOPTS}L(${MAXANA}))
exten => s,n,SET(VLIM=${ODBC_RTDB(Setup,VLIMIT)})
exten => s,n(limited),SET(ARG1=${IF(${EXISTS(${ARG1})}?${ARG1}:-1)})
exten => s,n,GotoIf($[${SERVMODE} = 1]?master)
exten => s,n,GotoIf($[${ARG1} < 0]?s-HANGUP,1)
exten => s,n,Macro(repdial,${CALLERID(number)},${ARG1})
exten => s,n,SET(NOCLID=${ODBC_FEATDB(${CALLERID(number)},NoCLID)})
exten => s,n,GotoIf(${EXISTS(${NOCLID})}?:cli)
exten => s,n,GotoIf($[${NOCLID} != ${ARG1}]?cli)
exten => s,n,SET(CALLERID(all)=)
exten => s,n,SET(ODBC_FEATDB(${ARG1},NoCLID)=NULL)
exten => s,n,Goto(s,dial)
exten => s,n(cli),GotoIF($[${LEN(${ARG1})} = 8]?localdial)
exten => s,n,GotoIF($[${LEN(${ARG1})} = 4]?localdial)
exten => s,n,GotoIF($[${LEN(${ARG1})} = 5]?localdial2)
exten => s,n,GotoIF($[[${LEN(${ARG1})} = 10] & $[${ARG1:0:1} = 1]]?localdial)
exten => s,n,SET(INTLOC=${ODBC_RTDB(Setup,IntLocal)})
exten => s,n,SET(INTLOC=${IF(${EXISTS(${INTLOC})}?${INTLOC}:0)})
exten => s,n,SET(INTACC=${ODBC_RTDB(Setup,IntAccess)})
exten => s,n,SET(INTACC=${IF(${EXISTS(${INTACC})}?${INTACC}:00)})
exten => s,n,GotoIF($[${REGEX("^${INTACC}" ${ARG1})} | $[${INTLOC} = 0]]?setnum)
exten => s,n,SET(CCODE=${ODBC_RTDB(Setup,Countrycode)})
exten => s,n,SET(CCODE=${IF(${EXISTS(${CCODE})}?${CCODE}:27)})
exten => s,n,SET(DNUM=${CCODE}${ARG1:1})
exten => s,n,GotoIF($[${INTLOC} = 1]?dialout)
exten => s,n,SET(ILPRE=${IF($[${INTLOC} = 2]?${INTACC}:+)})
exten => s,n,SET(DNUM=${ILPRE}${DNUM})
exten => s,n,Goto(dialout)

exten => s,n(setnum),SET(DNUM=${ARG1})

exten => s,n(dialout),GotoIF(${EXISTS(${PARENTDIAL})}?:noh323)
exten => s,n,GotoIf($["${PARENTDIAL}" = "OOH323"]?:setcli)
exten => s,n(noh323),SET(DNUM=${DNUM:2})

exten => s,n(setcli),SET(VLIM=${ODBC_RTDB(Setup,VLIMIT)})
exten => s,n,SET(VLIM=${IF(${EXISTS(${VLIM})}?${VLIM}:8)})

exten => s,n(pdial),GotoIf(${EXISTS(${PARENTDIAL})}?pcall)

exten => s,n+1(pcall),SET(NEWCNT=-1)
exten => s,n,SET(NEWCNT=-1)
exten => s,n,SET(WIN=0)
exten => s,n(avchkp),ChanIsAvail(${PARENTDIAL})
exten => s,n,SET(NEWCNT=${GROUP_COUNT(parent@out)})
exten => s,n,Goto(par1)

exten => s,avchkp+101(par1),SET(PNUM=1)
exten => s,n(getp),GotoIF($[${PARENTCNT} = ${PNUM}]?gotp)
exten => s,n,SET(PGRP=parent${PNUM}@out)
exten => s,n,SET(CURCNT=${GROUP_COUNT(${PGRP})})
exten => s,n(avchk),ChanIsAvail(${PARENTDIAL}${PNUM})
exten => s,n,NoOp($[${AVAILSTATUS} != 5])
exten => s,n,GotoIf($[$[${NEWCNT} <= ${CURCNT}] & $[${AVAILSTATUS} != 5]]?nextp)
exten => s,n,SET(NEWCNT=${CURCNT})
exten => s,n,SET(WIN=${PNUM})
exten => s,n(nextp),SET(PNUM=$[${PNUM} + 1])
exten => s,n,GotoIf($[$[${AVAILSTATUS} = 4] | $[${PARENTCNT} <= ${PNUM}]]?gotp:getp)

exten => s,avchk+101(gotp),GotoIf($[${WIN}> 0]?psdial)
exten => s,n,SET(GROUP(out)=parent)
exten => s,n,SET(T38STATUS=${IF(${EXISTS(${T38STATUS})}?${T38STATUS}:0)})
exten => s,n,SET(FAXTONE=${IF(${EXISTS(${FAXTONE})}?${FAXTONE}:NONE)})
exten => s,n,GotoIf($[["${FAXTONE}" != "NONE"] | ${T38STATUS}]?fax1)
exten => s,n,Dial(${PARENTDIAL}/${DNUM},,${CDOPTS})
exten => s,n,GotoIf($[${DIALSTATUS} != CHANUNAVAIL]?s-${DIALSTATUS},1)

exten => s,n+1(fax1),FaxGateway(${PARENTDIAL}/${DNUM})

exten => s,n+1(psdial),SET(GROUP(out)=parent${WIN})
exten => s,n,SET(T38STATUS=${IF(${EXISTS(${T38STATUS})}?${T38STATUS}:0)})
exten => s,n,SET(FAXTONE=${IF(${EXISTS(${FAXTONE})}?${FAXTONE}:NONE)})
exten => s,n,GotoIf($[["${FAXTONE}" != "NONE"] | ${T38STATUS}]?fax2)
exten => s,n,Dial(${PARENTDIAL}${WIN}/${DNUM},,${CDOPTS})
exten => s,n,GotoIf($[${DIALSTATUS} != CHANUNAVAIL]?s-${DIALSTATUS},1)

exten => s,n+1(fax2),FaxGateway(${PARENTDIAL}${WIN}/${DNUM})

exten => s,n+1(localdial),SET(ARRAY(LIBHOST,PREFIX,PROTO)="${ODBC_IBDB(${ARG1:0:2},"address,dprefix,proto")}")
exten => s,n,SET(LIBPRE=${ARG1:0:2})
exten => s,n,GotoIf(${EXISTS(${LIBHOST})}?localib:parent)

exten => s,n+1(localdial2),SET(ARRAY(LIBHOST,PREFIX,PROTO)="${ODBC_IBDB(${ARG1:0:3},"address,dprefix,proto")}")
exten => s,n,SET(LIBPRE=${ARG1:0:3})
exten => s,n,GotoIf(${EXISTS(${LIBHOST})}?localib:parent)

exten => s,n(parent),GotoIf(${EXISTS(${PARENTDIAL})}?:s-HANGUP,1)
exten => s,n,GotoIf(!${EXISTS(${VLIM})}?dialp)
exten => s,n,GotoIf($[${GROUP_COUNT(parent@out)} >= ${VLIM}]?s-OVERLIMIT)
exten => s,n,SET(GROUP(out)=parent)

exten => s,n(dialp),SET(T38STATUS=${IF(${EXISTS(${T38STATUS})}?${T38STATUS}:0)})
exten => s,n,SET(FAXTONE=${IF(${EXISTS(${FAXTONE})}?${FAXTONE}:NONE)})
exten => s,n,GotoIf($[["${FAXTONE}" != "NONE"] | ${T38STATUS}]?fax3)
exten => s,n,Dial(${PARENTDIAL}/${ARG1},,${CDOPTS})
exten => s,n,Goto(s-${DIALSTATUS},1)

exten => s,n+1(fax3),FaxGateway(${PARENTDIAL}/${DNUM})

exten => s,n+1(master),Set(TIMEOUT(digit)=2)
exten => s,n,SET(CALLERID(name)=${CALLERID(number)})
exten => s,n,Set(TIMEOUT(response)=4)
exten => s,n,Goto(${ARG1},1)

exten => s,n(localib),Macro(callergrp,${CALLERID(number)})
exten => s,n,GotoIf($[${PROTO} = SIP]?sip)
exten => s,n,GotoIf($[${PROTO} = IAX2]?iax:h323)
exten => s,n+1(sip),Dial(SIP/${PREFIX}${ARG1:${LEN(${LIBPRE})}}@${LIBHOST},120,WgT)
exten => s,n+1(iax),Dial(IAX2/guest@${LIBHOST}/${PREFIX}${ARG1:${LEN(${LIBPRE})}},120,WgT)
exten => s,n+1(h323),SET(ZPRE=0000)
exten => s,n,SET(PLEN=${MATH(4-${LEN(${LIBHOST})},i)})
exten => s,n,Dial(OOH323/000${ZPRE:1:${PLEN}}${LIBHOST}${PREFIX}${ARG1:${LEN(${LIBPRE})}},120,WgT)

exten => s,n,Goto(s-${DIALSTATUS},1)

;exten => s-ANSWER,1,SayDigits(${ANSWEREDTIME})
;exten => s-ANSWER,n,Background(seconds)
;exten => s-ANSWER,n,Background(goodbye)
exten => s-ANSWER,1,Hangup

exten => s-HANGUP,n,Hangup

exten => _s-.,1,GotoIf(${ARG2}?vfo)
exten => _s-.,n+1(vfo),GotoIf(${EXISTS(${VFO})}?hangup)
exten => _s-.,n,GotoIf($[${EXTEN:2} = BUSY]?busy)
exten => _s-.,n,Goto(macro-callout,trunk-dial,1)
exten => _s-.,n+1(hangup),Hangup
exten => _s-.,n+1(busy),Busy(5)

exten => _XXXXXXXX,1,Macro(stdexten,${ARG1},${CONTEXT})

exten => _XXXXXXXX.,1,SET(IPREFIX=0)
exten => _XXXXXXXX.,n,GotoIf($[${ARG1:1:1} = 9]?intnum)
exten => _XXXXXXXX.,n,SET(IPREFIX=0927)
exten => _XXXXXXXX.,n(intnum),SET(DNUM=${IPREFIX}${ARG1:1})
exten => _XXXXXXXX.,n,SET(RNUM=${ODBC_RTDB(H323Route,${DNUM})})
exten => _XXXXXXXX.,n,SET(VACC=${ODBC_SQL(account,provider,trunkprefix,${RNUM})})
exten => _XXXXXXXX.,n,AGI(agi://${AGISERVER}/prepaid.php?username=${VACC}&destination=${DNUM}&h323prefix=${RNUM})
exten => _XXXXXXXX.,n,Hangup

exten => _*XXXXXXXX.,1,Set(TIMEOUT(digit)=4)
exten => _*XXXXXXXX.,n,Set(TIMEOUT(response)=10)
exten => _*XXXXXXXX.,n,AGI(agi://${AGISERVER}/prepaid.php?username=${EXTEN:1:8}&destination=${EXTEN:9})
exten => _*XXXXXXXX.,n,Hangup

exten => h,1,GoSubIf(${EXISTS(${TOUCH_MONITOR_OUTPUT})}?automon,s,1)
exten => h,n,NoOp(Good Bye)

[macro-prepaid]
exten => s,1,SET(PPDIS=${ODBC_RTDB(Setup,PPDIS)})
exten => s,n,SET(PPDIS=${IF(${EXISTS(${PPDIS})}?${PPDIS}:1)})
exten => s,n,GotoIf(${PPDIS}?congest)
exten => s,n,SET(PP_TIME=${PPRATE(${ARG1},0001)})
exten => s,n,GotoIf(${EXISTS(${PP_TIME})}?:congest)
exten => s,n,SET(DIALOPTS=rL(${PP_TIME}:60000:30000))
exten => s,n,SET(DIALTOUT=120)
exten => s,n,GotoIf($[${PP_TTYPE} = SIP]?sip)
exten => s,n,Dial(${PP_TTYPE}/${PP_TRUNK}/${PP_DIAL},${DIALTOUT},${DIALOPTS})
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s,n(sip),Dial(${PP_TTYPE}/${PP_DIAL}@${PP_TRUNK},${DIALTOUT},${DIALOPTS})
exten => s,n,GotoIf($[${DIALSTATUS} = ANSWER]?bill)
exten => s,n,GotoIf($[${DIALSTATUS} = BUSY]?busy)
exten => s,n,GotoIf($[${DIALSTATUS} = CONGESTION]?congest)
exten => s,n,GotoIf($[${DIALSTATUS} = CHANUNAVAIL]?congest)
exten => s,n,Hangup
exten => s,n+1(bill),SayDigits(${ANSWEREDTIME})
exten => s,n+1(congest),Congestion(5)
exten => s,n+1(busy),Busy(5)

[macro-gossipdial]
exten => s,1,Macro(repdial,${CALLERID(number)},${ARG1})
exten => s,n,SET(NOCLID=${ODBC_FEATDB(${CALLERID(number)},NoCLID)})
exten => s,n,GotoIf(${EXISTS(${NOCLID})}?:cli)
exten => s,n,GotoIf($[${NOCLID} != ${ARG1})]?cli)
exten => s,n,SET(CALLERID(number)=${GOSIPTEL})
exten => s,n,SET(ODBC_FEATDB(${ARG1},NoCLID)=NULL)
exten => s,n,Goto(s,dial)
exten => s,n(cli),SET(CALLERID(number)=${GOSSIPTEL})
exten => s,n(dial),Dial(SIP/${ARG1}@sip.gossiptel.com,,WgT)
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s-ANSWER,1,SayDigits(${ANSWEREDTIME})
exten => s-ANSWER,n,Background(seconds)
exten => s-ANSWER,n,Background(goodbye)
exten => s-ANSWER,n,Hangup
exten => _s-.,1,GotoIf($[${ARG2} != 0]?trunk)
exten => _s-.,n,Hangup
exten => _s-.,n(trunk),Macro(callout,09${ARG1:2},${PARENTDIAL}/09${ARG1:2},${CALLERID(number)},5,5,${CONTEXT})

[macro-faxsend] 
exten => s,1,Answer()
exten => s,n,Wait(5)
exten => s,n,SendFax(${ARG1})

[macro-faxreceive] 
exten => s,1,SET(LOCALSTATIONID=+27 (${ODBC_RTDB(Setup,AreaCode):1}) ${ODBC_RTDB(Setup,ExCode)}-${ODBC_SQL(name,users,name,${ARG1})})
exten => s,n,SET(LOCALHEADERINFO=${ODBC_SQL(fullname,users,name,${ARG1})})
exten => s,n,SET(MAILBOX=${ODBC_RTDB(DDIFAX,${ARG1})})
exten => s,n,GotoIf(${EXISTS(${MAILBOX})}?gotfbox)
exten => s,n,SET(UMAILBOX=${ODBC_SQL(email,users,name,${ARG1})})
exten => s,n,SET(MAILBOX=${ODBC_RTDB(Setup,FAXBOX)})
exten => s,n,SET(MAILBOX=${IF(${EXISTS(${MAILBOX})}?${MAILBOX}:astfax)})
exten => s,n,SET(MAILBOX=${IF(${EXISTS(${UMAILBOX})}?${UMAILBOX}:${MAILBOX})})
exten => s,n(gotfbox),SET(CIDNUM=${CALLERID(number)})
exten => s,n,SET(CIDNUM=${IF(${EXISTS(${CIDNUM})}?${CIDNUM}:Unknown)})
exten => s,n,SET(FAXFILE=${ARG1}-${UNIQUEID})
exten => s,n,SET(MAILCMD=/usr/bin/fax2mail ${FAXFILE} ${ARG1} ${CIDNUM} ${DOMAIN} ${MAILBOX} ${FAXPAGES} "${REMOTESTATIONID}")
exten => s,n,SET(FAXOPT(gateway)=no)
exten => s,n,ReceiveFAX(/var/spool/asterisk/fax/${FAXFILE}.tif,debug)

exten => h,1,System(${MAILCMD})

[macro-iaxteldial]
exten => s,1,Macro(repdial,${CALLERID(number)},${ARG1})
exten => s,n,SET(NOCLID=${ODBC_FEATDB(${CALLERID(number)},NoCLID)})
exten => s,n,GotoIf(${EXISTS(${NOCLID})}?:cli)
exten => s,n,GotoIf($[${NOCLID} != ${ARG1})]?cli)
exten => s,n,SET(CALLERID(all)=)
exten => s,n,SET(ODBC_FEATDB(${ARG1},NoCLID)=NULL)
exten => s,n,Goto(s,dial)
exten => s,n(cli),SET(CALLERID(number)=${IAXTELNUM})
exten => s,n(dial),Dial(IAX2/iaxtel/${ARG1},,WgT)
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s-ANSWER,1,SayDigits(${ANSWEREDTIME})
exten => s-ANSWER,n,Background(seconds)
exten => s-ANSWER,n,Background(goodbye)
exten => s-ANSWER,n,Hangup
exten => _s-.,1,GotoIf($[${ARG1:0:2} != 17]?hangup)
exten => _s-.,n,Macro(fwddial,*${ARG1})
exten => _s-.,n(hangup),Hangup

[macro-firefly]
exten => s,1,Macro(repdial,${CALLERID(number)},${ARG1})
exten => s,n,SET(NOCLID=${ODBC_FEATDB(${CALLERID(number)},NoCLID)})
exten => s,n,GotoIf(${EXISTS(${NOCLID})}?:cli)
exten => s,n,GotoIf($[${NOCLID} != ${ARG1})]?cli)
exten => s,n,SET(CALLERID(all)=)
exten => s,n,SET(ODBC_FEATDB(${ARG1},NoCLID)=NULL)
exten => s,n,Goto(s,dial)
exten => s,n(cli),SET(CALLERID(number)=${FRESHNUM})
exten => s,n(dial),Dial(IAX2/${FRESHNUM}/${ARG1},,WgT)
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s-ANSWER,1,SayDigits(${ANSWEREDTIME})
exten => s-ANSWER,n,Background(seconds)
exten => s-ANSWER,n,Background(goodbye)
exten => s-ANSWER,n,Hangup
exten => _s-.,1,Hangup

[macro-callout]
exten => s,1,Macro(repdial,${ARG3},${ARG1})
exten => s,n,SET(TRANSFER_CONTEXT=6)
exten => s,n,SET(FWDCALL=${IF(${EXISTS(${FWDCALL})}?${FWDCALL}:0)})
exten => s,n,SET(EMERG=${IF(${EXISTS(${ODBC_RTDB(EMERG,${ARG1})})}?1:0)})
exten => s,n,GotoIf($[$["${CHANNEL}" = "Console/dsp"] | ${EMERG}]?:checkauth)
exten => s,n,SET(ACCESS=${ARG5})
exten => s,n,SET(ACCESSO=${ARG5})
exten => s,n,Goto(cgroup)
exten => s,n+1(checkauth),GotoIf(${FWDCALL}?fwdcall)
exten => s,n,Macro(getacc,)
exten => s,n,Goto(cgroup)
exten => s,n(fwdcall),SET(ACCESS=${AACCESS})
exten => s,n(cgroup),GotoIf($[${ACCESS} >= ${ARG4}]?loaduser)
exten => s,n,GotoIf($[${ACCESSO} >= ${ARG4}]?:noauth)
exten => s,n,Macro(authuser,${ARG3})
exten => s,n,GotoIf($[${ARG3} = ${NEWUSER}]?authc)
exten => s,n,SET(ARG3=${NEWUSER})
exten => s,n,Macro(getacc,${ARG3})
exten => s,n(authc),GotoIf($[${ACCESSO} >= ${ARG4}]?:noauth)
exten => s,n,ResetCDR(v)
exten => s,n(loaduser),GotoIf($[$[${ARG4} = 0] || $[${EMERG} = 1]]?nopurse)
exten => s,n,SET(INPURSE=${ODBC_PURSE(${ARG3})})
exten => s,n,SET(INPURSE=${IF(${EXISTS(${INPURSE})}?${INPURSE}:1)})
exten => s,n,GotoIf(${INPURSE}?:nocred)
exten => s,n(nopurse),Macro(callergrp,${ARG3},${ARG1})
exten => s,n,SET(CDR(userfield)=${ARG1})

exten => s,n,SET(DEFRECORD=${ODBC_RTDB(Setup,DEFRECORD)})
exten => s,n,SET(DEFCLI=${ODBC_RTDB(Setup,DefCLI)})
exten => s,n,SET(VRCON=${ODBC_RTDB(Setup,IPContext)})

exten => s,n,SET(DEFRECORD=${IF(${EXISTS(${DEFRECORD})}?${DEFRECORD}:0)})
exten => s,n,SET(DEFCLI=${IF(${EXISTS(${DEFCLI})}?${DEFCLI}:0)})
exten => s,n,SET(VRCON=${IF(${EXISTS(${VRCON})}?${VRCON}:6)})

exten => s,n,SET(ARRAY(CWAIT,RECORD,NOVOIP,EFAXD,NOCLID,NOPRES,UTRUNK,CLIPRES)="${ODBC_FEATDB(${ARG3},"wait,record,novoip,efaxd,noclid,nopres,trunk,cli")}")

exten => s,n,SET(TRUNK=${IF(${EXISTS(${UTRUNK})}?"${UTRUNK}":"${ODBC_RTDB(Setup,Trunk)}")})
exten => s,n,SET(RECORD=${IF(${EXISTS(${RECORD})}?${RECORD}:${DEFRECORD})})
exten => s,n,SET(EFAXD=${IF(${EXISTS(${EFAXD})}?${EFAXD}:0)})
exten => s,n,SET(CLIPRES=${IF(${EXISTS(${CLIPRES})}?${CLIPRES}:0)})

exten => s,n,SET(DIALSTATUS=CHANUNAVAIL)
;exten => s,n,Agi(agi://${AGISERVER}/calllog.php?remchan=${CDR(channel)}&dstchan=${CDR(dstchannel)})
exten => s,n,GotoIf($[${EFAXD} > 1]?:record)
;exten => s,n,WaitFax(4)
exten => s,n,SET(T38STATUS=${IF(${EXISTS(${T38STATUS})}?${T38STATUS}:0)})
exten => s,n,SET(FAXTONE=${IF(${EXISTS(${FAXTONE})}?${FAXTONE}:NONE)})
exten => s,n(record),GotoIf($[${RECORD} != 1]?authok)
exten => s,n,SET(CLOGID=${IF(${EXISTS(${DDIUNIQUEID})}?${DDIUNIQUEID}:${CDR(linkedid)})})
exten => s,n,SET(CALLLEG=${ODBC_LOGCOUNT(${CLOGID})})
exten => s,n,SET(ODBC_LOG(${CLOGID},${CALLLEG},${CHANNEL})=${ARG3})
exten => s,n,SET(CALLDATE=${IF(${EXISTS(${CALLDATE})}?${CALLDATE}:${STRFTIME(,,%Y-%m-%d)})})
exten => s,n,SET(MONITOR_EXEC_ARGS=${ODBC_RTDB(Setup,RecOpt)})
exten => s,n,Monitor(wav49,/var/spool/asterisk/monitor/${CALLDATE}/${ARG3}/${CLOGID}-${CALLLEG},mb)
exten => s,n(authok),GotoIf(${EXISTS(${NOCLID})}?:setcli)
exten => s,n,GotoIf($[$[${NOCLID} != ${ARG1}] & $[${NOPRES} != 1]]?setcli)
exten => s,n,SET(CALLERID(number)=)
exten => s,n,SET(ODBC_FEATDB(${ARG3},NoCLID)=NULL)
exten => s,n,Set(CALLERPRES()=prohib)
exten => s,n,Goto(s-dial,1)

exten => s,n+1(setcli),SET(CLIPRES=${IF($[${CLIPRES} = 0]?:${CLIPRES})})
exten => s,n,SET(AUTOCLI=${ODBC_RTDB(Setup,AutoCLI)})
exten => s,n,SET(AUTOCLI=${IF(${EXISTS(${AUTOCLI})}?${AUTOCLI}:0)})}
exten => s,n,GotoIf($[${AUTOCLI} & !${EXISTS(${CLIPRES})}]?:cliset)
exten => s,n,SET(CLIPRES=${ARG3})
exten => s,n,SET(EXCODECLI=${ODBC_RTDB(Setup,AddExCLI)})
exten => s,n,SET(EXCODECLI=${IF(${EXISTS(${EXCODECLI})}?${EXCODECLI}:1)})}
exten => s,n,GotoIf($[${EXCODECLI} = 0]?cliset)
exten => s,n,SET(EXCODE=${ODBC_RTDB(Setup,ExCode)})
exten => s,n,SET(CLIPRES=${EXCODE}${CLIPRES})
exten => s,n(cliset),SET(CLIPRES=${IF(${EXISTS(${CLIPRES})}?${CLIPRES}:${DEFCLI})})}
exten => s,n,GotoIf($[${CLIPRES} = 0]?s-dial,1)
exten => s,n,SET(CALLERID(all)=)
exten => s,n,SET(CALLERID(number)=${CLIPRES})
exten => s,n,SET(CALLERID(ANI)=${CLIPRES})
exten => s,n,Goto(s-dial,1)

exten => s,n+1(noauth),Background(not-auth-pstn,n)
exten => s,n,Hangup
exten => s,n+1(nocred),Background(not-enough-credit,n)
exten => s,n,Hangup

exten => s-dial,1,SET(NOENUM=${ODBC_RTDB(Setup,NoEnum)})
exten => s-dial,n,SET(NOENUM=${IF(${EXISTS(${NOENUM})}?${NOENUM}:1)})
exten => s-dial,n,GotoIf(${NOVOIP}?nogsm)
exten => s-dial,n,GotoIf(${EXISTS(${GSMPAT})}?:nogsm)
exten => s-dial,n,GoSubIf(${REGEX("${GSMPAT}" ${ARG1})}?gsmrouter,${ARG1},1:nogsm)
exten => s-dial,n,GotoIf(${EXISTS(${CELLGW})}?:nogsm)
exten => s-dial,n,Dial(${CELLGW},,Wgt)

exten => s-dial,n(nogsm),GotoIF($[${NOENUM} = 1]?:noenum)
exten => s-dial,n(useenum),GotoIF($[${ARG4} = 0]?noenum)
exten => s-dial,n,GotoIF($[${ARG1:1:1} != 9]?lenum:ienum)
exten => s-dial,n(lenum),macro(enumlookup,27${ARG1:1})
exten => s-dial,n,GotoIF(${EXISTS(${DIALSTATUS})}?:noenum)
exten => s-dial,n,GotoIF($[${DIALSTATUS} != ANSWER]?noenum:s-${DIALSTATUS},1)
exten => s-dial,n(ienum),macro(enumlookup,${ARG1:2})
exten => s-dial,n,GotoIF(${EXISTS(${DIALSTATUS})}?:noenum)
exten => s-dial,n,GotoIF($[${DIALSTATUS} != ANSWER]?noenum:s-${DIALSTATUS},1)
exten => s-dial,n(noenum),GotoIF(${EXISTS(${ARG2})}?:s-CHANUNAVAIL,1)
exten => s-dial,n,GotoIf(${NOVOIP}?trunk-dial,1)

exten => s-dial,n,SET(TELCOP="${ODBC_RTDB(Setup,TPremiumPat)}")
exten => s-dial,n,GotoIf(${EXISTS(${TELCOP})}?:crt)
exten => s-dial,n,GotoIf(${REGEX("^${TELCOP}" ${ARG1})}?nocrt)
exten => s-dial,n(crt),Dial(${ARG2},,WgT)
exten => s-dial,n,Goto(s-${DIALSTATUS},1)

exten => s-dial,n+1(nocrt),Dial(${ARG2},,WgT)
exten => s-dial,n,Goto(s-${DIALSTATUS},1)

exten => s-CHANUNAVAIL,1,GotoIF(${EXISTS(${ARG2})}?:trunk,1)

exten => s-NOANSWER,1,BackGround(nbdy-avail-to-take-call,n)
exten => s-NOANSWER,n,Hangup

exten => s-BUSY,1,Busy(5)
exten => s-BUSY,n,Hangup

exten => s-ANSWER,1,Hangup

exten => s-CONGESTION,1,GotoIF(${EXISTS(${ARG2})}?:trunk,1)
;exten => s-CONGESTION,1,Congestion(5)
;exten => s-CONGESTION,n,Hangup

exten => trunk,1,GotoIf($[${ACCESSO} < ${ARG5}]?deny)
exten => trunk,n,GotoIf(${NOVOIP}?trunk-dial,1)
exten => trunk,n,GotoIf($[${VRCON} > ${ARG5}]?trunk-dial,1)
;Uncommment to force trunk
;exten => trunk,n,GotoIF(${EXISTS(${TRUNK})}?trunk-dial,1)
exten => trunk,n,GotoIF(${EXISTS(${PARENTDIAL})}?:trunkd)
exten => trunk,n,Macro(vroute,${ARG1},1)
exten => trunk,n(trunkd),Goto(trunk-dial,1)

exten => trunk,n+1(deny),BackGround(channel,n)
exten => trunk,n,BackGround(is-curntly-unavail,n)
exten => trunk,n,Hangup

exten => trunk-CHANUNAVAIL,1,Playtones(info)
exten => trunk-CONGESTION,1,Congestion(5)

exten => trunk-NOANSWER,1,BackGround(nbdy-avail-to-take-call,n)
exten => trunk-NOANSWER,n,Hangup

exten => trunk-BUSY,1,Busy(5)
exten => trunk-BUSY,n,Hangup

exten => trunk-ANSWER,1,Hangup

exten => trunk-dial,1,SET(TPRE=${ODBC_RTDB(Setup,TrunkPre)})
exten => trunk-dial,n,SET(TSTRIP=${ODBC_RTDB(Setup,TrunkStrip)})
exten => trunk-dial,n,SET(TSTRIP=${IF(${EXISTS(${TSTRIP})}?${TSTRIP}:0)})
exten => trunk-dial,n,SET(DIALSTATUS=${IF(${EXISTS(${DIALSTATUS})}?${DIALSTATUS}:CHANUNAVAIL)})
exten => trunk-dial,n,SET(DNUM=${ARG1:${TSTRIP}})
exten => trunk-dial,n,SET(DNUM=${IF(${EXISTS(${TPRE})}?${TPRE}${DNUM}:${DNUM})})

exten => trunk-dial,n,Macro(configdial,${TRUNK},${DNUM})
exten => trunk-dial,n,GotoIf($[$[${DIALSTATUS} != CHANUNAVAIL] | ${EXISTS(${UTRUNK})}]?trunk-${DIALSTATUS},1)

exten => trunk-dial,n,Macro(configdial,${ODBC_RTDB(Setup,Trunk2)},${DNUM})
exten => trunk-dial,n,GotoIf($[${DIALSTATUS} != CHANUNAVAIL]?trunk-${DIALSTATUS},1)

exten => trunk-dial,n,Macro(configdial,${ODBC_RTDB(Setup,Trunk3)},${DNUM})
exten => trunk-dial,n,GotoIf($[${DIALSTATUS} != CHANUNAVAIL]?trunk-${DIALSTATUS},1)

exten => trunk-dial,n,Macro(configdial,${ODBC_RTDB(Setup,Trunk4)},${DNUM})
exten => trunk-dial,n,GotoIf($[${DIALSTATUS} != CHANUNAVAIL]?trunk-${DIALSTATUS},1)

exten => trunk-dial,n,SET(VFO=${ODBC_RTDB(Setup,VoipFallover)})
exten => trunk-dial,n,SET(VFO=${IF(${EXISTS(${VFO})}?${VFO}:1)})
exten => trunk-dial,n,GotoIf($[${VFO} = 1]?:novfo)
exten => trunk-dial,n,Macro(vroute,${ARG1},1)
exten => trunk-dial,n,Goto(trunk-${DIALSTATUS},1)

exten => trunk-dial,n+1(novfo),Goto(trunk-${DIALSTATUS},1)

exten => h,1,GoSubIf(${EXISTS(${TOUCH_MONITOR_OUTPUT})}?automon,s,1)
exten => h,n,GoSubIf(${EXISTS(${GSMCHAN})}?gsmrouter,c,1:default,h,1)

[macro-configdial]
exten => s,1,SET(TTRUNK=${IF(${EXISTS(${ARG1})}?"${ARG1}":NONE)})
exten => s,n,GotoIf($["${TTRUNK}" != "NONE"]?checkc)
exten => s,n+1(checkc),SET(DNUM2=${ARG2})
exten => s,n,SET(CTECH=${CUT(TTRUNK,/,1)})
exten => s,n,GotoIf($[${CTECH} = mISDN]?:zap2dahdi)
exten => s,n,misdn_check_l2l1(${CUT(TTRUNK,/,2)},2)
exten => s,n,SET(DNUM2=${DNUM2}/e128)
exten => s,n,Goto(cavail)

;exten => s,n,SET(DNUM2=${DNUM2}/emg2ec)
;exten => s,n,Goto(chavail)
;exten => s,n,GotoIf($[${CTECH} = mISDN]?:cavail)
;exten => s,n,misdn_check_l2l1(${CUT(TTRUNK,/,2)},2)
;exten => s,n,SET(DNUM2=${DNUM2}/e128)
;exten => s,n,SET(DNUMF=/!e:vt0:vr0)

exten => s,n(zap2dahdi),GotoIf($[${CTECH} = Zap]?:cavail)
exten => s,n,SET(TTRUNK=Dahdi/${CUT(TTRUNK,/,2)}/)
exten => s,n(cavail),ChanIsAvail(${TTRUNK}${DNUM},j)
exten => s,n,GotoIf($[${AVAILSTATUS} != 5]?chavail)

exten => s,n+1(chavail),SET(FWDCALL=${IF(${EXISTS(${FWDCALL})}?${FWDCALL}:0)})
exten => s,n,SET(CDOPTS=${IF(${FWDCALL}?wgt:WgT)})
exten => s,n,GotoIf($[${CTECH} = Zap]?:dial)
exten => s,n,SET(ZGROUP=${CUT(TTRUNK,/,2):1})
exten => s,n,SET(ZSIG=${ODBC_SQL(signalling,zapgroup,zaptrunk,${ZGROUP})})
exten => s,n,SET(TTRUNK=${CUT(AVAILCHAN,,1)}/)
exten => s,n,GotoIf($[${CUT(ZSIG,_,1)} = pri]?dial)
exten => s,n,SET(MAXANA=${ODBC_RTDB(Setup,MaxAna)})
exten => s,n,SET(MAXANA=${IF(${EXISTS(${MAXANA})}?${MAXANA}:1200000)})
exten => s,n,SET(CDOPTS=${CDOPTS}L(${MAXANA}))
exten => s,n,Goto(limited)
exten => s,n(dial),SET(MAXALL=${ODBC_RTDB(Setup,MaxAll)})
exten => s,n,SET(MAXALL=${IF(${EXISTS(${MAXALL})}?${MAXALL}:0)})
exten => s,n,GotoIf(${MAXALL}?:limited)
exten => s,n,SET(MAXANA=${ODBC_RTDB(Setup,MaxAna)})
exten => s,n,SET(MAXANA=${IF(${EXISTS(${MAXANA})}?${MAXANA}:1200000)})
exten => s,n,SET(CDOPTS=${CDOPTS}L(${MAXANA}))
exten => s,n(limited),SET(T38STATUS=${IF(${EXISTS(${T38STATUS})}?${T38STATUS}:0)})
exten => s,n,SET(FAXTONE=${IF(${EXISTS(${FAXTONE})}?${FAXTONE}:NONE)})
exten => s,n,GotoIf($[["${FAXTONE}" != "NONE"] | ${T38STATUS}]?fax)
exten => s,n,SET(NOBRIDGE=${ODBC_RTDB(Setup,NoBridge)})
exten => s,n,SET(NOBRIDGE=${IF(${EXISTS(${NOBRIDGE})}?${NOBRIDGE}:0)})
exten => s,n,GotoIf(${NOBRIDGE}?proxy)
exten => s,n,Dial(${TTRUNK}${DNUM2},,${CDOPTS})

exten => s,n+1(fax),FaxGateway(${TTRUNK}${ARG2}${DNUMF})

exten => s,n+1(proxy),SET(DB(NOBRIDGE/${CDR(linkedid)})=${TTRUNK}${DNUM2}:${CDOPTS})
exten => s,n,Dial(Local/${ARG2}@trunkproxy)

exten => s,cavail+101,NoOp

[macro-stdexten]
exten => s,1,Macro(repdial,${CALLERID(number)},${ARG1})
exten => s,n,SET(VMBOX=${ARG1})
;exten => s,n,SLAStation(${ARG1})
exten => s,n,SET(CDR(userfield)=${ARG1})
exten => s,n,SET(CDR(accountcode)=${CALLERID(number)})
;Get global settings
exten => s,n,SET(STOUT=${ODBC_RTDB(Setup,Timeout)})
exten => s,n,SET(SRECORD=${ODBC_RTDB(Setup,DEFRECORD)})
exten => s,n,SET(SNOVMAIL=${ODBC_RTDB(Setup,DEFNOVMAIL)})
exten => s,n,SET(LFWD=${ODBC_RTDB(Setup,LocalFwd)})
exten => s,n,SET(REMFWDD=${ODBC_RTDB(Setup,REMDEF)})
;Set global overides
exten => s,n,SET(STOUT=${IF(${EXISTS(${STOUT})}?${STOUT}:20)})
exten => s,n,SET(SRECORD=${IF(${EXISTS(${SRECORD})}?${SRECORD}:0)})
exten => s,n,SET(SNOVMAIL=${IF(${EXISTS(${SNOVMAIL})}?${SNOVMAIL}:0)})
exten => s,n,SET(LFWD=${IF(${EXISTS(${LFWD})}?${LFWD}:1)})
exten => s,n,SET(REMFWDD=${IF(${EXISTS(${REMFWDD})}?${REMFWDD}:0)})

exten => s,n,SET(ARRAY(TOUT,CDND,CFNA,CFBU,CWAIT,NoCLID,RECORD,CFIM,NOVMAIL,EFAXD,DOPTS,UFTRUNK,IAXLINE,ISDNLINE,H323LINE,ZAPLINE,PTYPE,DDIPASS)="${ODBC_FEATDB(${ARG1},"tout,cdnd,cfna,cfbu,wait,noclid,record,cfim,novmail,efaxd,dfeat,fwdu,iaxline,isdnline,h323line,zapline,ptype,ddipass")}")

exten => s,n,SET(UFTRUNK=${IF(${EXISTS(${UFTRUNK})}?"${UFTRUNK}":${REMFWDD})})
exten => s,n,SET(LFWD=${IF($[${EXISTS(${DDIORIGIN})} | ${LFWD}]?1:0)})
exten => s,n,SET(EFAXD=${IF($[${EXISTS(${DDIORIGIN})} & $[${EFAXD} > 0]]?${EFAXD}:0)})

exten => s,n,SET(TOUT=${IF(${EXISTS(${TOUT})}?${TOUT}:${STOUT})})
exten => s,n,SET(RECORD=${IF(${EXISTS(${RECORD})}?${RECORD}:${SRECORD})})
exten => s,n,SET(NOVMAIL=${IF(${EXISTS(${NOVMAIL})}?${NOVMAIL}:${SNOVMAIL})})

exten => s,n,Macro(getacc,)
;exten => s,n,GotoIf(${EXISTS(${WINPOP})}?:setopts)
;exten => s,n,system(/usr/bin/echo -e "'Incoming Call From: ${CALLERID(name)} <${CALLERID(number)}>\\nReceived: ${STRFTIME(${,,%Y-%m-%d)}'"|/usr/bin/smbclient -U ${HOSTNAME} -M ${WINPOP})
exten => s,n(setopts),GotoIf($[${DOPTS} != 1]?nofeat)
exten => s,n,SET(DOPTS=${IF(${RECORD}?gt:${IF(${DOPTS}?gwWtT:gwt)})})
exten => s,n,Goto(reccall)
exten => s,n(nofeat),SET(DOPTS=g)

exten => s,n(reccall),GotoIf($[${RECORD} != 1]?faxdetect)
exten => s,n,SET(CLOGID=${IF(${EXISTS(${DDIUNIQUEID})}?${DDIUNIQUEID}:${CDR(linkedid)})})
exten => s,n,SET(CALLLEG=${ODBC_LOGCOUNT(${CLOGID})})
exten => s,n,SET(ODBC_LOG(${CLOGID},${CALLLEG},${CHANNEL})=${ARG1})
exten => s,n,GotoIf($[${CALLLEG} > 24]?hangup)
exten => s,n(startmon),SET(CALLDATE=${IF(${EXISTS(${CALLDATE})}?${CALLDATE}:${STRFTIME(,,%Y-%m-%d)})})
exten => s,n,SET(MONITOR_EXEC_ARGS=${ODBC_RTDB(Setup,RecOpt)})
exten => s,n,Monitor(wav49,/var/spool/asterisk/monitor/${CALLDATE}/${ARG1}/${CLOGID}-${CALLLEG},mb)

exten => s,n(faxdetect),GotoIF($[${EFAXD} > 0]?:fwding)
exten => s,n,GotoIf($[${CHANNEL(state)} = Up]?fwding)
exten => s,n,WaitFax(4,ring)
exten => s,n,SET(FAXDETECTED=${IF($[${FAXOPT(status)} = SUCCESS]?1:0)})
exten => s,n,GotoIf(${FAXDETECTED}?fax,${ARG1},2)
exten => s,n(fwding),GotoIF($[$[${CFIM} != 0] & $[${CFIM} != ${ARG1}]]?cfwd)
exten => s,n,GotoIF($[${CDND} = 1]?s-NOANSWER,1)
exten => s,n,GotoIF(${EXISTS(${NoCLID})}?:cwait)
exten => s,n,GotoIf($[${NOCLID} != ${ARG1}]?cwait)
exten => s,n,SET(CALLERID(all)=)
exten => s,n,SET(ODBC_FEATDB(${ARG1},NoCLID)=NULL)

exten => s,n(cwait),GotoIf(${EXISTS(${ARG1})}?:dial)
exten => s,n,GotoIF($[${CWAIT} = 1]?dial)
exten => s,n,GotoIf($[$[${GROUP_COUNT(${ARG1}@called)} >= 1] | $[${GROUP_COUNT(${ARG1}@caller)} >= 1] | $[${GROUP_COUNT(${ARG1}@pickup)} >= 1] | $[${GROUP_COUNT(${ARG1}@qagent)} >= 1]]?s-BUSY,1)
exten => s,n(dial),Macro(callergrp,${CALLERID(num)},${ARG1})
exten => s,n,Goto(${ARG1},1)

exten => s,n(cfwd),SET(CDR(userfield)=${ARG1})
exten => s,n,Macro(getacc,${ARG1})
exten => s,n,GotoIF($[${LEN(${CFIM})} > 4]?callout)
exten => s,n,Goto(userout,${CFIM},1)
exten => s,n,Hangup
exten => s,n+1(callout),SET(FWDCALL=1)
exten => s,n,SET(CALLERID(number)=${ARG1})
exten => s,n,SET(CDR(accountcode)=${ARG1})
exten => s,n,Goto(userout,${CFIM},1)
exten => s,n(hangup),Hangup

exten => s-NOANSWER,1,SET(CFNA=${IF(${EXISTS(${CFNA})}?${CFNA}:0)})
exten => s-NOANSWER,n,GotoIF($[${CFNA} = 0]?vmail)
exten => s-NOANSWER,n,GotoIF($[${LEN(${CFNA})} > 4]?callout)
exten => s-NOANSWER,n,GotoIf(${LFWD}?:busy)
exten => s-NOANSWER,n,Goto(userout,${CFNA},1)
exten => s-NOANSWER,n,Hangup
exten => s-NOANSWER,n+1(callout),SET(FWDCALL=1)
exten => s-NOANSWER,n,SET(CALLERID(number)=${ARG1})
exten => s-NOANSWER,n,SET(CDR(accountcode)=${ARG1})
exten => s-NOANSWER,n,Goto(userout,${CFNA},1)
exten => s-NOANSWER,n,Hangup
exten => s-NOANSWER,n(vmail),GotoIf($[$[${NOVMAIL} = 1] & ${LFWD}]?defroute)
exten => s-NOANSWER,n,GotoIf($[${NOVMAIL} = 1]?busy)
exten => s-NOANSWER,n,Macro(vmaildel,${VMBOX},0)
exten => s-NOANSWER,n,Hangup
exten => s-NOANSWER,n+1(defroute),SET(DEF9=${ODBC_RTDB(Setup,Default_9)})
exten => s-NOANSWER,n,SET(DEF9=${IF(${EXISTS(${DEF9})}?${DEF9}:1)})
exten => s-NOANSWER,n,GotoIf(${DEF9}?default,9,1:busy)
exten => s-NOANSWER,n+1(busy),Busy(5)
exten => s-NOANSWER,n,Hangup

exten => s-BUSY,1,SET(CFBU=${IF(${EXISTS(${CFBU})}?${CFBU}:0)})
exten => s-BUSY,n,GotoIF($[${CFBU} = 0]?vmail)
exten => s-BUSY,n,GotoIF($[${LEN(${CFBU})} > 4]?callout)
exten => s-BUSY,n,GotoIf(${LFWD}?:busy)
exten => s-BUSY,n,Goto(userout,${CFBU},1)
exten => s-BUSY,n,Hangup
exten => s-BUSY,n+1(callout),SET(FWDCALL=1)
exten => s-BUSY,n,SET(CALLERID(number)=${ARG1})
exten => s-BUSY,n,SET(CDR(accountcode)=${ARG1})
exten => s-BUSY,n,Goto(userout,${CFBU},1)
exten => s-BUSY,n,Hangup
exten => s-BUSY,n(vmail),GotoIf($[$[${NOVMAIL} = 1] & ${LFWD}]?defroute)
exten => s-BUSY,n,GotoIf($[${NOVMAIL} = 1]?busy)
exten => s-BUSY,n,Macro(vmaildel,${ARG1},1)
exten => s-BUSY,n,Hangup
exten => s-BUSY,n+1(defroute),SET(DEF9=${ODBC_RTDB(Setup,Default_9)})
exten => s-BUSY,n,SET(DEF9=${IF(${EXISTS(${DEF9})}?${DEF9}:1)})
exten => s-BUSY,n,GotoIf(${DEF9}?default,9,1:busy)
exten => s-BUSY,n+1(busy),Busy(5)
exten => s-BUSY,n,Hangup

exten => s-ANSWER,1,Hangup

exten => s-,1,SET(UNKHU=${ODBC_RTDB(Setup,UNKDEF)})
exten => s-,n,SET(UNKHU=${IF(${EXISTS(${UNKHU})}?${UNKHU}:0)})
exten => s-,n,GotoIf(${UNKHU}?:s-NOANSWER,1)
exten => s-,n,Hangup

exten => _s-.,1,Goto(s-NOANSWER,1)

exten => _XXX.,1,SET(AGENTCHAN=${AGENT(${EXTEN}:channel)})
exten => _XXX.,n,GotoIf(${EXISTS(${AGENTCHAN})}?agent)

exten => _XXX.,n,GotoIF($["${UFTRUNK}" = "0"]?noftr)
exten => _XXX.,n,GotoIF($["${UFTRUNK}" = "1"]?:ftrdial)
exten => _XXX.,n,SET(UFTRUNK=${ODBC_RTDB(Setup,FTrunk)})
exten => _XXX.,n,GotoIF($["${UFTRUNK}" = "NONE"]?noftr)
exten => _XXX.,n(ftrdial),SET(FWDNUM=${ODBC_FWDNUM(${EXTEN})})
exten => _XXX.,n,SET(FWDNUM=${IF(${EXISTS(${FWDNUM})}?${FWDNUM}:${EXTEN})})
exten => _XXX.,n,SET(CHANNEL(callgroup)=${ODBC_SQL(callgroup,users,name,${EXTEN})})
exten => _XXX.,n,Dial(${UFTRUNK}${FWDNUM},${TOUT},wgt)
exten => _XXX.,n,GotoIf(${ISNULL(${HANGUPCAUSE})}?s-${DIALSTATUS},1)
exten => _XXX.,n,GotoIf($[${HANGUPCAUSE} != 88]?s-${DIALSTATUS},1)
exten => _XXX.,n,Dial(Local/${FWDNUM}@ftrunkproxy,${TOUT},wgt)
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n(noftr),SET(H323LINE=${IF(${EXISTS(${H323LINE})}?${H323LINE}:0)})
exten => _XXX.,n,GotoIF($[${H323LINE} = 1]?h323)

exten => _XXX.,n(h323pre),SET(H323LINE=${ODBC_RTDB(H323Prefix,${EXTEN:0:2})})
exten => _XXX.,n,SET(H323LINE=${IF(${EXISTS(${H323LINE})}?${H323LINE}?:0)})
exten => _XXX.,n,GotoIF($[${H323LINE} = 1]?h323)

exten => _XXX.,n(zap),SET(ZAPTR=${IF(${EXISTS(${ZAPLINE})}?1:0)})
exten => _XXX.,n,GotoIF($[${ZAPTR} != 0]?:misdn)
exten => _XXX.,n,GotoIF($[${ZAPLine} != 0]?:misdn)
exten => _XXX.,n,Dial(Dahdi/${ZAPLINE},${TOUT},wgt)
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n(misdn),SET(ISDNLINE=${IF(${EXISTS(${ISDNLINE})}?${ISDNLINE}:0)})
exten => _XXX.,n,GotoIF($[${ISDNLINE} != 0]?:iax)
exten => _XXX.,n,Dial(MISDN/${ISDNLINE}/${EXTEN},${TOUT},wgt)
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n(iax),SET(IAXLINE=${IF(${EXISTS(${IAXLINE})}?${IAXLINE}:0)})
exten => _XXX.,n,GotoIF($[${IAXLINE} = 1]?:sip)
exten => _XXX.,n,Dial(IAX2/${ARG1},${TOUT},wgt)
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n(h323),Dial(OOH323/${EXTEN},${TOUT},wgt)
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n(agent),Dial(Agent/${EXTEN},${TOUT},whgt)
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n(sip),SET(NAME=${ODBC_SQL(name,users,name,${ARG1})})
exten => _XXX.,n,GotoIf(${EXISTS(${NAME})}?sipdial)
exten => _XXX.,n,SET(DDIFWD=${ODBC_RTDB(DDI,${EXTEN})})
exten => _XXX.,n,GotoIf(${EXISTS(${DDIFWD})}?userout,${DDIFWD},1)
exten => _XXX.,n,SET(EXCODE=${ODBC_RTDB(Setup,ExCode)})
exten => _XXX.,n,SET(ACODE=${ODBC_RTDB(Setup,AreaCode)})
exten => _XXX.,n,Macro(enumlookup,27${ACODE:1}${EXCODE}${ARG1})
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n+1(sipdial),SET(SIPREFER=${IF(${EXISTS(${SIPREFER})}?${SIPREFER}:0)})
exten => _XXX.,n,GotoIf(${SIPREFER}?callsip)
exten => _XXX.,n,GotoIf($[${PTYPE} != SNOM]?callsip)
exten => _XXX.,n,sipaddheader("Alert-Info:<http://www.notused.com>\;info=${ALERTINF}\;x-line-id=0")
exten => _XXX.,n,Goto(callsip)
;exten => _XXX.,n(polyinf),GotoIf($[${PTYPE} = LINKSYS]?callsip)
;exten => _XXX.,n,sipaddheader("Alert-Info:<${ALERTINF}>")

exten => _XXX.,n(callsip),SET(KAMSIP=${ODBC_KAMAILIO(${EXTEN})})
exten => _XXX.,n,GotoIf(${EXISTS(${KAMSIP})}?kamailio)
exten => _XXX.,n,SET(SARG=${IF($[${EXISTS(${DDIFWD})} & ${DDIPASS}]?${ARG1}/${ODBC_DDIFWD(${DDIORIGIN})}:${ARG1})})
;exten => _XXX.,n,GotoIf(${T38STATUS}?faxgw)
exten => _XXX.,n,Dial(SIP/${SARG},${TOUT},${DOPTS})
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n+1(faxgw),FaxGateway(SIP/ecn/0115770419,${TOUT})
exten => _XXX.,n,NoOp(${FAXSTATUS})
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

exten => _XXX.,n+1(kamailio),Dial(${KAMSIP},${TOUT},${DOPTS})
exten => _XXX.,n,Goto(s-${DIALSTATUS},1)

[macro-prepaycall]
exten => s,1,SET(TECH=${CUT(CHANNEL,/,1)})
exten => s,n,GotoIf($[$[${TECH} = SIP] | $[${TECH} = IAX2]]?checkpre)
exten => s,n+1(checkpre),SET(EXNUM=${CUT(CUT(CHANNEL,/,2),-,1)})
exten => s,n,SET(USERTYPE=${ODBC_SQL(usertype,users,name,${EXNUM})})
exten => s,n,SET(USERTYPE=${IF(${EXISTS(${USERTYPE})}?${USERTYPE}:0)})
exten => s,n,GotoIf($[$[${USERTYPE} > 0] & $[${LEN(${ARG1})} > 5]]?prepaid,${ARG1},1)

[prepaid]
exten => _X.,1,SET(DESTNUM=${EXTEN})
exten => _X.,n,AGI(agi://${AGISERVER}/prepaid.php?username=${EXNUM}&destination=${DESTNUM}&h323gwid=${HOSTNAME})
exten => _X.,n,Hangup

exten => h,1,NoCdr
exten => h,n,AGI(agi://${AGISERVER}/prepaid.php?username=${EXNUM}&destination=${DESTNUM}&h323gwid=${HOSTNAME})
exten => h,n(hangup),Goto(default,h,1)

[macro-getuser]
exten => s,1,SET(EXNUM=${CUT(CHANNEL,/,2)})
exten => s,n,SET(EXNUM=${CUT(EXNUM,-,1)})
exten => s,n,GotoIf($[${TECH} = DAHDI]?zapline)
exten => s,n,GotoIf($[${TECH} = Zap]?zapline)
exten => s,n+1(zapline),SET(EXNUM=${ODBC_GETZAP(${CHANNEL})})

[macro-getacc]
exten => s,1,GotoIf(${EXISTS(${BLINDTRANSFER})}?setacc)
exten => s,n,GotoIf(${EXISTS(${SDIAL})}?allowall)
exten => s,n,SET(TECH=${CUT(CHANNEL,/,1)})
exten => s,n,GotoIf($[$[${TECH} = H323] & !${EXISTS(${ARG1})}]?allowall)
exten => s,n,GotoIf($[$[${TECH} = OOH323] & !${EXISTS(${ARG1})}]?ooh323)
exten => s,n,GotoIf($[$[${TECH} = mISDN] & !${EXISTS(${ARG1})}]?allowall)
exten => s,n,GotoIf($[$[${TECH} = WOOMERA] & !${EXISTS(${ARG1})}]?allowall)
exten => s,n,GotoIf($[$[${TECH} = Console] & !${EXISTS(${ARG1})}]?allowall)
exten => s,n,GotoIf($[$[${TECH} = Local] & ${EXISTS(${CDR(accountcode)})}]?localacok)
exten => s,n,GotoIf($[$[${TECH} = Local] & !${EXISTS(${ARG1})}]?allowall)
exten => s,n,GotoIf($[$[${TECH} = Zap] & !${EXISTS(${ARG1})}]?zapline)
exten => s,n,GotoIf($[$[${TECH} = DAHDI] & !${EXISTS(${ARG1})}]?zapline)
exten => s,n(setacc),SET(EXNUM=${IF(${EXISTS(${ARG1})}?${ARG1}:${CUT(CUT(IF(${EXISTS(${BLINDTRANSFER})}?${BLINDTRANSFER}:${CHANNEL}),/,2),-,1)})})
exten => s,n(accok),SET(CDR(accountcode)=${EXNUM})
exten => s,n,SET(ARRAY(ACCESS,LOCKED,AACCESS,ALOCK)="${ODBC_FEATDB(${EXNUM},"access,locked,authaccess,alock")}")
exten => s,n,SET(LOCKED=${IF(${EXISTS(${LOCKED})}?${LOCKED}:0)})

exten => s,n,SET(ACCESS=${IF(${EXISTS(${ACCESS})}?${ACCESS}:${ODBC_RTDB(Setup,Context)})})
exten => s,n,SET(AACCESS=${IF(${EXISTS(${AACCESS})}?${AACCESS}:${ODBC_RTDB(Setup,AuthContext)})})
exten => s,n,SET(ACCESS=${IF(${EXISTS(${ACCESS})}?${ACCESS}:0)})
exten => s,n,SET(AACCESS=${IF(${EXISTS(${AACCESS})}?${AACCESS}:${ACCESS})})
exten => s,n,SET(ACCESS=${IF(${LOCKED}?0:${ACCESS})})
exten => s,n,SET(AACCESS=${IF(${LOCKED}?0:${AACCESS})})
exten => s,n,SET(AUTOAUTH=${ODBC_FEATDB(${EXNUM},autoauth)})
exten => s,n,SET(AUTOAUTH=${IF(${EXISTS(${AUTOAUTH})}?${AUTOAUTH}:0)})
exten => s,n,SET(ACCESS=${IF(${AUTOAUTH}?0:${ACCESS})})
exten => s,n,SET(SERVICETIME=${ODBC_TIME(${ODBC_RTDB(${EXNUM},BGRP)})})
exten => s,n,GotoIf(${EXISTS(${SERVICETIME})}?:afterh)
exten => s,n,GotoIf($["${SERVICETIME}" = "1"]?officeh)
exten => s,n,GotoIf($["${SERVICETIME}" = "*"]?afterh)
exten => s,n,GotoIfTime(${SERVICETIME},*,*,*?officeh)
exten => s,n(afterh),SET(SALOCK=${ODBC_RTDB(Setup,DEFALOCK)})
exten => s,n,SET(SALOCK=${IF(${EXISTS(${SALOCK})}?${SALOCK}:${AACCESS})})
exten => s,n,SET(ALOCK=${IF(${EXISTS(${ALOCK})}?${ALOCK}:${SALOCK})})
exten => s,n,SET(ACCESS=${IF($[${ALOCK} < ${ACCESS}]?${ALOCK}:${ACCESS})})

exten => s,n(officeh),SET(AACCESS=${IF(${AUTOAUTH}?0:${AACCESS})})
exten => s,n,SET(ACCESSO=${IF($[${AACCESS} > ${ACCESS}]?${AACCESS}:${ACCESS})})

exten => s,n+1(zapline),SET(EXNUM=${ODBC_GETZAP(${CHANNEL})})
exten => s,n,GotoIf(${EXISTS(${EXNUM})}?accok)
exten => s,n,GotoIf(${EXISTS(${CDR(accountcode)})}?localacok:allowall)

exten => s,n+1(ooh323),SET(EXNUM=${CALLER_H323ID})
exten => s,n,GotoIf(${EXISTS(${EXNUM})}?:nouser)
exten => s,n,GotoIf($[${EXNUM} = t38modem]?allowall)
exten => s,n,Goto(accok)
exten => s,n+1(nouser),GotoIf(${EXISTS(${NEIGH})}?:noallow)
exten => s,n,SET(CDR(accountcode)=${NEIGH})
exten => s,n,Goto(allowall)

exten => s,n+1(localacok),SET(EXNUM=${CDR(accountcode)})
exten => s,n,Goto(accok)

exten => s,n+1(allowall),SET(ACCESS=5)
exten => s,n,SET(ACCESSO=5)

exten => s,n+1(noallow),SET(ACCESS=0)
exten => s,n,SET(ACCESSO=0)

[macro-vmlogin]
exten => s,1,GotoIf($[${CHANNEL(state)} = Up]?upchan)
exten => s,n,Answer
exten => s,n(upchan),Read(USER,vm-login)
exten => s,n,Macro(authuser,${USER})

[macro-authuser]
exten => s,1,GotoIf($[${CHANNEL(state)} = Up]?upchan)
exten => s,n,Answer
exten => s,n,Wait(1)
exten => s,n(upchan),GotoIf($[${ARG1} = 9]?admin)
exten => s,n,SET(PWTRY=0)
exten => s,n(start),Read(UPASS,vm-password,${ODBC_PINLEN()})

exten => s,n,SET(PWTYPE=${ODBC_PWAUTH(${ARG1},${UPASS})})
exten => s,n,SET(PWTYPE=${IF(${EXISTS(${PWTYPE})}?${PWTYPE}:0)})
exten => s,n,SET(AUTHLEV=${ODBC_RTDB(Setup,LINEAUTH)})
exten => s,n,SET(AUTHLEV=${IF(${EXISTS(${AUTHLEV})}?${AUTHLEV}:2)})
exten => s,n,GotoIf($[${PWTYPE} >= ${AUTHLEV} ]?end)

exten => s,n,SET(PINCNT=${ODBC_GETUCNT(RoamPass,${UPASS})})
exten => s,n,SET(PINCNT=${IF(${EXISTS(${PINCNT})}?${PINCNT}:0)})
exten => s,n,GotoIF($[${PINCNT} = 0]?nopin)
exten => s,n,GotoIF($[${PINCNT} > 1]?nopin)

exten => s,n,SET(NEWUSER=${ODBC_GETPIN(${UPASS})})
exten => s,n,GotoIf($[${EXISTS(${NEWUSER})} & ${EXISTS(${UPASS})}]?:nopin)
exten => s,n,GotoIf($[${NEWUSER} = ${ARG1}]?setuser)

exten => s,n,SET(ADVPIN=${ODBC_RTDB(Setup,ADVPIN)})
exten => s,n,SET(ADVPIN=${IF(${EXISTS(${ADVPIN})}?${ADVPIN}:0)})
exten => s,n,GotoIf(${ADVPIN}?:setuser)

exten => s,n,Read(CEXTEN,vm-extension,4)
exten => s,n,GotoIf($[${CEXTEN} = ${NEWUSER}]?setuser:nopin)

exten => s,n(nopin),Playback(vm-incorrect)
exten => s,n,Set(PWTRY=$[${PWTRY} + 1])
exten => s,n,GotoIf($[${PWTRY} < 3]?start)
exten => s,n,Background(vm-goodbye)
exten => s,n,Hangup
exten => s,n+1(end),Background(auth-thankyou)
exten => s,n,SET(NEWUSER=${ARG1})
exten => s,n+1(admin),SET(UPASS=${ODBC_RTDB(Setup,AdminPass)})
exten => s,n,GotoIf(${EXISTS(${UPASS})}?:noadmin)
exten => s,n,Authenticate(${UPASS})
exten => s,n+1(noadmin),Read(UPASS,agent-pass,4)
exten => s,n,SET(ODBC_RTDB(Setup,AdminPass)=${UPASS})
exten => s,n,SayDigits(${UPASS})
exten => s,n+1(setuser),Background(auth-thankyou)
exten => s,n,SET(CDR(accountcode)=${NEWUSER})

[macro-repdial]
exten => s,1,GotoIf(${EXISTS(${ARG1})}?:exit)
exten => s,n,SET(LOCALXPREFIX=${ODBC_RTDB(LocalPrefix,${ARG1:0:2})})
exten => s,n,GotoIf(${EXISTS(${LOCALXPREFIX})}?repdial:exit)
exten => s,n+1(repdial),GotoIf(${EXISTS(${ARG2})}?:exit)
exten => s,n,SET(ODBC_FEATDB(${ARG1},repeatdial)=${ARG2})
exten => s,n(exit),NoOp()

;701-749 parked calls

[macro-callqueue]
exten => s,1,SET(CHANT=${CUT(CHANNEL,/,1)})
exten => s,n,GotoIf($[${CHANT} = Local]?answer)
exten => s,n,GotoIf($[${QUEUE_MEMBER(${ARG1},logged)} = 0]?t,1)
exten => s,n,SET(MAXLEN=${ODBC_SQL(maxlen,queue_table,name,${ARG1})})
exten => s,n,GotoIf($[${QUEUE_WAITING_COUNT(${ARG1})} >= ${MAXLEN}]?busy)
exten => s,n(delay),GotoIf($[${QRDELAY} = 0]?answer)
exten => s,n,Wait(${QRDELAY})
exten => s,n(answer),GotoIf($[${CHANNEL(state)} = Up]?begin)
exten => s,n,Answer
exten => s,n(begin),SET(BGRP=${ODBC_RTDB(${DDIORIGIN},BGRP)})
exten => s,n,SET(QNAME="${IF(${EXISTS(${BGRP})}?"${BGRP}":"${ARG1}")}")
exten => s,n,SET(MOH=${ODBC_SQL(musiconhold,queue_table,name,${ARG1})})
exten => s,n,SET(MOH=${IF(${EXISTS(${MOH})}?${MOH}:default)})
exten => s,n,Set(CHANNEL(musicclass)=${MOH})
exten => s,n,SET(CALLERID(name)=${QNAME}-${CALLERID(number)} ${CALLERID(name)})
exten => s,n,SET(TIMEOUT(digit)=1)
exten => s,n,SET(TIMEOUT(response)=1)
exten => s,n,SET(DQTIMEOUT=${ODBC_RTDB(Setup,QTimeout)})
exten => s,n,SET(DQTIMEOUT=${IF(${EXISTS(${DQTIMEOUT})}?${DQTIMEOUT}:600)})
exten => s,n,SET(QTIMEOUT=${IF(${EXISTS(${QTIMEOUT})}?${QTIMEOUT}:${DQTIMEOUT})})
exten => s,n,GotoIf($[${QVMFWD} != NONE]?qcdr)
exten => s,n,SET(QVMFWD=)
exten => s,n(qcdr),SET(CDR(userfield)=${ARG1})
exten => s,n,SET(CDR(accountcode)=${CALLERID(number)})
exten => s,n,GotoIF($[${ARG1} = 799]?default,9,1)
exten => s,n,ResetCdr
exten => s,n,SET(PLAYAGENT=0)
exten => s,n(enterq),GotoIF(${EXISTS(${DDIORIGIN})}?:noanoun)

exten => s,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/1${DDIORIGIN}.alaw)}?playcaller)
exten => s,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/1${DDIORIGIN}.gsm)}?:nomsg)
exten => s,n(playcaller),Background(custom/1${DDIORIGIN})
exten => s,n(nomsg),GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/2${DDIORIGIN}.alaw)}?setpagent)
exten => s,n,GotoIf(${STAT(f,/var/lib/asterisk/sounds/custom/2${DDIORIGIN}.gsm)}?:noanoun)
exten => s,n(setpagent),SET(PLAYAGENT=1)
exten => s,n(playagent),GotoIf($[${PLAYAGENT} != 1]?noanoun)
exten => s,n,Queue(${ARG1},h${QDOPTS},,custom/2${DDIORIGIN},${QTIMEOUT},,queueconnect)
exten => s,n+1(noanoun),Queue(${ARG1},h${QDOPTS},,,${QTIMEOUT},,queueconnect)

exten => s,n+1(busy),Busy(5)


exten => t,1,Goto(queues,t,1)
exten => h,1,Goto(queues,h,1)

[macro-setddi]
exten => s,1,Macro(authuser,9)
exten => s,n,SET(NUMBER=${CUT(ARG1,*,1)})
exten => s,n,SET(DDI=${CUT(ARG1,*,2)})
exten => s,n,SET(ODBC_RTDB(DDI,${NUMBER})=${DDI})
exten => s,n,Background(activated)
exten => s,n,Background(for)
exten => s,n,SayDigits(${ARG1:0:${NUMBER}})
exten => s,n,Background(extension)
exten => s,n,SayDigits(${TMP:1})
exten => s,n,Hangup

[macro-delddi]
exten => s,1,Macro(authuser,9)
;exten => s,n,SET(ODBC_RTDB(DDI,${ARG1}))
exten => s,n,SET(ODBC_RTDB(DDI,${ARG1})=)
exten => s,n,Background(de-activated)
exten => s,n,Background(for)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Hangup

[macro-setboolean]
exten => s,1,Macro(authuser,9)
exten => s,n,SET(BVAL=${ODBC_RTDB(${ARG2},${ARG1})})
exten => s,n,SET(BVAL=${IF(${EXISTS(${BVAL})}?${BVAL}:0)})
exten => s,n,Gotoif($[${BVAL} = 1]?del:add)
exten => s,n(add),SET(ODBC_RTDB(${ARG2},${ARG1})=1)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Background(added)
exten => s,n,Hangup
exten => s,n(del),SET(ODBC_RTDB(${ARG2},${ARG1})=0)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Background(removed)
exten => s,n,Hangup

[macro-setuboolean]
exten => s,1,Macro(authuser,${ARG2})
exten => s,n,SET(BVAL=${ODBC_FEATDB(${ARG2},${ARG1})})
exten => s,n,SET(BVAL=${IF(${EXISTS(${BVAL})}?${BVAL}:0)})
exten => s,n,Gotoif($[${BVAL} = 1]?del:add)
exten => s,n(add),SET(ODBC_FEATDB(${ARG2},${ARG1})=1)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Background(added)
exten => s,n,Hangup
exten => s,n(del),SET(ODBC_FEATDB(${ARG2},${ARG1})=0)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Background(removed)
exten => s,n,Hangup

[macro-setsystem]
exten => s,1,Macro(authuser,9)
exten => s,n,SET(ACTION=${IF(${EXISTS(${ARG2})}?1:0)})
exten => s,n,Gotoif($[${ACTION} = 1]?add:del)
exten => s,n(add),SET(ODBC_RTDB(Setup,${ARG1})=${ARG2})
exten => s,n,Background(added)
exten => s,n,SayDigits(${ARG2})
exten => s,n,Hangup
exten => s,n(del),SET(ODBC_RTDB(Setup,${ARG1})=)
exten => s,n,Background(removed)
exten => s,n,Hangup

[macro-redial]
exten => s,1,Answer
exten => s,n,SET(RDIAL=${ODBC_FEATDB(${CALLERID(number)},repeatdial)})
exten => s,n,GotoIF(${EXISTS(${RDIAL})}?:fail)
exten => s,n,macro(getacc,)
exten => s,n,Goto(${ACCESSO},${RDIAL},1)
exten => s,n+1(fail),Congestion(5)

[macro-saytime]
exten => s,1,SayUnixTime
exten => s,n,Hangup

[macro-lastcall]
exten => s,1,Background(info-about-last-call)
exten => s,n,Background(telephone-number)
exten => s,n,SET(NUMBER=${ODBC_FEATDB(${CALLERID(number)},repeatdial)})
exten => s,n,GotoIf(${EXISTS(${NUMBER})}?:fail)
exten => s,n,SayDigits(${NUMBER})
exten => s,n,Background(time)
exten => s,n,SET(TIMEON=${ODBC_RTDB(${CALLERID(number)},LastCall)})
exten => s,n,GotoIf(${EXISTS(${TIMEON})}?:fail)
exten => s,n,SayDigits(${TIMEON})
exten => s,n,Background(seconds)
exten => s,n,Hangup
exten => s,n+1(fail),Background(is-not-set)
exten => s,n,Hangup

[macro-testchan]
exten => s,1,Background(extension)
exten => s,n,SayDigits(${ARG1})
exten => s,n(avail),ChanIsAvail(SIP/${ARG1}&IAX2/${ARG1}&OOH323/${ARG1},j)
exten => s,n,Background(is-currently)
exten => s,n,Background(accessible-through-system)
exten => s,n,Hangup
exten => s,avail+101,Background(is-curntly-unavail)
exten => s,n,Hangup

[macro-donotdisturb]
exten => s,1,SET(CDND=${ODBC_FEATDB(${CALLERID(number)},CDND)})
exten => s,n,SET(SNOM=${IF(${EXISTS(${ARG1})}?${ARG1}:0)})
exten => s,n,SET(CDND=${IF(${EXISTS(${CDND})}?${CDND}:0)})
exten => s,n,GotoIF($[${SNOM} = 0]?setdnd)
exten => s,n,Answer
exten => s,n,GotoIf(${EXISTS(${ARG2})}?:setdnd)
exten => s,n,GotoIf($[$[${ARG2} = 0] & $[${CDND} = 1]]?deact)
exten => s,n,GotoIf($[$[${ARG2} = 1] & $[${CDND} = 0]]?setdnd:hangup)
exten => s,n+1(setdnd),GotoIF($[${CDND} = -1]?hangup)
exten => s,n,GotoIF($[${CDND} = 1]?deact)
exten => s,n,SET(ODBC_FEATDB(${CALLERID(number)},CDND)=1)
;exten => s,n,SET(RPEN=${ODBC_QUEUE(penalty,799,${CUT(CHANNEL,-,1)})})
;exten => s,n,SET(RPEN=${IF(${EXISTS(${RPEN})}?${RPEN}:-1)})
;exten => s,n,GotoIf($[${RPEN} <= 0]?aoff)
;exten => s,n,RemoveQueueMember(799)
exten => s,n(aoff),SET(ODBC_AGENTOFF(${CUT(CHANNEL,-,1)})=0)
exten => s,n,GotoIF($[${SNOM} = 1]?hangup)
exten => s,n,Background(do-not-disturb)
exten => s,n,Background(activated)
exten => s,n,Hangup
exten => s,n(deact),Macro(repdial,${CALLERID(number)},${EXTEN})
exten => s,n,SET(ODBC_FEATDB(${CALLERID(number)},CDND)=0)
exten => s,n,SET(ODBC_AGENTON(${CUT(CHANNEL,-,1)})=1)
exten => s,n,GotoIF($[${SNOM} = 1]?hangup)
exten => s,n,Background(do-not-disturb)
exten => s,n,Background(de-activated)
exten => s,n(hangup),Hangup

[macro-receptionqueue]
exten => s,1,SET(IFACE=${CUT(CHANNEL,-,1)})
exten => s,n,SET(AQUEUE=${ODBC_RTDB(Setup,AttendantQ)})
exten => s,n,SET(AQUEUE=${IF(${EXISTS(${AQUEUE})}?${AQUEUE}:799)})
exten => s,n,SET(PENALTY=${ODBC_QUEUE(penalty,${AQUEUE},${IFACE})})
exten => s,n,SET(PENALTY=${IF(${EXISTS(${PENALTY})}?${PENALTY}:-1)})
exten => s,n,GotoIf(${EXISTS(${ARG2})}?:setagent)
exten => s,n,GotoIf($[$[${ARG2} = 1] & $[${ARG3} = -2]]?logoff)
exten => s,n,GotoIf($[$[${ARG2} = 0] & $[${ARG3} = 2]]?setagent:hangup)
exten => s,n(setagent),GotoIF($[${PENALTY} >= 0]?logoff)
exten => s,n,SET(APENALTY=${ODBC_RTDB(Setup,AAPenalty)})
exten => s,n,SET(APENALTY=${IF(${EXISTS(${APENALTY})}?${APENALTY}:20)})
exten => s,n,SET(DPENALTY=${ODBC_RTDB(Setup,QAPenalty)})
exten => s,n,SET(DPENALTY=${IF(${EXISTS(${DPENALTY})}?${DPENALTY}:${APENALTY})})
exten => s,n,SET(PENALTY=${ODBC_QUEUE(defpenalty,${AQUEUE},${IFACE},${CALLERID(number)})})
exten => s,n,SET(PENALTY=${IF(${EXISTS(${PENALTY})}?${PENALTY}:${DPENALTY})})
exten => s,n(logon),SET(ODBC_QUEUE(penalty,${AQUEUE},${IFACE},${CALLERID(number)})=${PENALTY})
exten => s,n,SET(QUEUE_MEMBER(${AQUEUE},penalty,${IFACE})=${PENALTY})
exten => s,n,UserEvent(Agentlogin,Agent: ${CALLERID(number)})
exten => s,n,Background(agent-loginok)
exten => s,n,Hangup
exten => s,n+1(logoff),SET(ODBC_QUEUE(penalty,${AQUEUE},${IFACE},${CALLERID(number)})=-1)
exten => s,n,SET(QUEUE_MEMBER(${AQUEUE},penalty,${IFACE})=-1)
exten => s,n,UserEvent(Agentlogoff,Agent: ${CALLERID(number)})
exten => s,n,Background(agent-loggedoff)
exten => s,n,Hangup

[macro-setattendant]
exten => s,1,Macro(authuser,9)
exten => s,n,Macro(callergrp,${ARG1})
exten => s,n,SET(ODBC_RTDB(Setup,Attendant)=${ARG1})
exten => s,n,Background(agent-loginok)
exten => s,n,Background(default-attendant)
exten => s,n,Background(now)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Hangup

[macro-setivr]
exten => s,1,Macro(callergrp,${CALLERID(number)})
exten => s,n,Macro(authuser,9)
exten => s,n,SET(ODBC_RTDB=(Setup,Attendant=0))
exten => s,n,Background(agent-loggedoff)
exten => s,n,Hangup

[macro-modetogle]
exten => s,1,Macro(authuser,9)
exten => s,n,SET(VMODE=${ODBC_RTDB(Setup,Mode)})
exten => s,n,SET(VMODE=${IF(${EXISTS(${VMODE})}?${VMODE}:0)})
exten => s,n,GotoIf($[${VMODE} = 0]?act)
exten => s,n,SET(ODBC_RTDB(Setup,Mode)=0)
exten => s,n,BackGround(de-activated)
exten => s,n,Hangup
exten => s,n(act),SET(ODBC_RTDB(Setup,Mode)=1)
exten => s,n,BackGround(activated)
exten => s,n,Hangup

[macro-queuelogin]
exten => s,1,Macro(authuser,${CALLERID(number)})
exten => s,n,SET(IFACE=${CUT(CHANNEL,-,1)})
exten => s,n,SET(PENALTY=${ODBC_QUEUE(penalty,${ARG1},${IFACE})})
exten => s,n,SET(PENALTY=${IF(${EXISTS(${PENALTY})}?${PENALTY}:-1)})
exten => s,n,GotoIF($[${PENALTY} >= 0]?logoff)
exten => s,n,SET(DPENALTY=${ODBC_RTDB(Setup,QAPenalty)})
exten => s,n,SET(DPENALTY=${IF(${EXISTS(${DPENALTY})}?${DPENALTY}:20)})
exten => s,n,SET(PENALTY=${ODBC_QFEATDB(${ARG1},penalty)})
exten => s,n,SET(PENALTY=${IF(${EXISTS(${PENALTY})}?${PENALTY}:${DPENALTY})})
exten => s,n,SET(UDPENALTY=${ODBC_QUEUE(defpenalty,${ARG1},${IFACE})})
exten => s,n,SET(PENALTY=${IF(${EXISTS(${UDPENALTY})}?${UDPENALTY}:${PENALTY})})
exten => s,n,SET(ODBC_QUEUE(penalty,${ARG1},${IFACE},${CALLERID(number)})=${PENALTY})
exten => s,n,SET(QUEUE_MEMBER(${ARG1},penalty,${IFACE})=${PENALTY})
exten => s,n,UserEvent(Agentlogin,Agent: ${CALLERID(number)})
exten => s,n,Background(agent-loginok)
exten => s,n,Hangup
exten => s,n(logoff),SET(QUEUE_MEMBER(${ARG1},penalty,${IFACE})=-1)
exten => s,n,UserEvent(Agentlogoff,Agent: ${CALLERID(number)})
exten => s,n,Background(agent-loggedoff)
exten => s,n,Hangup

[macro-anoncall]
exten => s,1,SET(ODBC_FEATDB(${CALLERID(number)},NoCLID)=${ARG1})
exten => s,n,Goto(userout,${ARG1},1)

[macro-fwdunavail]
exten => s,1,GotoIF($[${CALLERID(number)} = ${ARG1}]?fwd)
exten => s,n,Macro(authuser,${CALLERID(number)})
exten => s,n(fwd),GotoIF(${EXISTS(${ARG2})}?set:del)
exten => s,n(set),SET(ODBC_FEATDB(${ARG1},CFNA)=${ARG2})
exten => s,n,Background(call-fwd-no-ans)
exten => s,n,Background(activated)
exten => s,n,Hangup
exten => s,n(del),SET(ODBC_FEATDB(${ARG1},CFNA)=)
exten => s,n,Background(call-fwd-no-ans)
exten => s,n,Background(de-activated)
exten => s,n,Hangup

[macro-fwdim]
exten => s,1,Macro(authuser,${ARG1})
exten => s,n,GotoIF(${EXISTS(${ARG2})}?fwd:del)
exten => s,n+1(fwd),SET(ODBC_FEATDB(${ARG1},CFIM)=${ARG2})
exten => s,n,Background(call-fwd-unconditional)
exten => s,n,Background(activated)
exten => s,n,Hangup
exten => s,n+1(del),SET(ODBC_FEATDB(${ARG1},CFIM)=)
exten => s,n,Background(call-fwd-unconditional)
exten => s,n,Background(de-activated)
exten => s,n,Hangup

[macro-fwdbusy]
exten => s,1,GotoIF($[${CALLERID(number)} = ${ARG1}]?fwd)
exten => s,n,Macro(authuser,${CALLERID(number)})
exten => s,n(fwd),GotoIF(${EXISTS(${ARG2})}?set:del)
exten => s,n(set),SET(ODBC_FEATDB(${ARG1},CFBU)=${ARG2})
exten => s,n,Background(call-fwd-on-busy)
exten => s,n,Background(activated)
exten => s,n,Hangup
exten => s,n(del),SET(ODBC_FEATDB(${ARG1},CFBU)=)
exten => s,n,Background(call-fwd-on-busy)
exten => s,n,Background(de-activated)
exten => s,n,Hangup

[macro-vmaildel]
exten => s,1,SET(LOCALPREFIX=${ODBC_RTDB(LocalPrefix,${ARG1:0:2})})
exten => s,n,SET(LOCALPREFIX=${IF(${EXISTS(${LOCALPREFIX})}?${LOCALPREFIX}:0)})
exten => s,n,SET(VMCONT=1)
exten => s,n,GotoIf($[${LOCALPREFIX} != 1]?invalid)
exten => s,n,SET(TIMEOUT(DIGIT)=1)
exten => s,n,SET(TIMEOUT(RESPONSE)=1)
exten => s,n,Gotoif($[${ARG2} = 2]?skip)
exten => s,n,Answer()

exten => s,n,SET(FINF=${STAT(f,/var/spool/asterisk/voicemail/6/${ARG1}/temp.WAV)})
exten => s,n,SET(FINF=${IF(${EXISTS(${FINF})}?${FINF}:0)})
exten => s,n,GotoIf($[${FINF} != 1]?notemp)
;exten => s,n,Background(/var/spool/asterisk/voicemail/6/${ARG1}/temp,m,,macro-vmaildel)
exten => s,n,WaitExten(1.5)
exten => s,n,Goto(skip)

exten => s,n+1(notemp),SET(BUNMSG=${IF($[${ARG2} = 0]?unavail:busy)})
exten => s,n,SET(FINF=${STAT(f,/var/spool/asterisk/voicemail/6/${ARG1}/${BUNMSG}.WAV)})
exten => s,n,SET(FINF=${IF(${EXISTS(${FINF})}?${FINF}:0)})
exten => s,n,GotoIf($[${FINF} != 1]?nomsg)
exten => s,n,Background(/var/spool/asterisk/voicemail/6/${ARG1}/${BUNMSG},m,,macro-vmaildel)
exten => s,n,WaitExten(1.5)
exten => s,n,Goto(skip)

exten => s,n+1(nomsg),SET(FINF=${STAT(f,/var/spool/asterisk/voicemail/6/${ARG1}/greet.WAV)})
exten => s,n,SET(FINF=${IF(${EXISTS(${FINF})}?${FINF}:0)})
exten => s,n,GotoIf($[${FINF} != 1]?nogreet)
exten => s,n,Background(/var/spool/asterisk/voicemail/6/${ARG1}/greet,m,,macro-vmaildel)
exten => s,n,WaitExten(1.5)
exten => s,n,Goto(status)

exten => s,n(nogreet),Background(vm-theperson,m,,macro-vmaildel)
exten => s,n,SayDigits(${ARG1})
exten => s,n(status),Gotoif($[${ARG2} = 0]?unavail)
exten => s,n(busy),Background(vm-isonphone,m,,macro-vmaildel)
exten => s,n,Goto(vmail)
exten => s,n+1(unavail),Background(vm-isunavail,m,,macro-vmaildel)
exten => s,n(vmail),SET(NOOPER=${ODBC_RTDB(Setup,NoOper)})
exten => s,n,SET(NOOPER=${IF(${EXISTS(${NOOPER})}?${NOOPER}:0)})
exten => s,n,GotoIf($[!${NOOPER}]?:noopmsg)
exten => s,n,Background(to-reach-operator,m,,macro-vmaildel)
exten => s,n,Background(press-0,m,,macro-vmaildel)
exten => s,n,Background(or,m,,macro-vmaildel)
exten => s,n(noopmsg),Background(vm-intro,m,,macro-vmaildel)
exten => s,n,WaitExten(1.5)
exten => s,n(skip),Voicemail(${ARG1}@6,s)
exten => s,n(invalid),Congestion(5)

exten => 0,1,Goto(default,9,1)
exten => 9,1,Goto(default,9,1)
exten => o,1,Goto(default,9,1)
exten => a,1,Macro(stdexten,${ARG1},${CONTEXT})

exten => fax,1,Goto(fax,fax,1)

[confcall]
exten => _9XX,1,SET(CONF=${EXTEN})
exten => _9XX,n,Macro(callergrp,${CALLERID(number)})
exten => _9XX,n,MeetMeCount(${CONF},MMCNT)
exten => _9XX,n,GotoIf($[${MMCNT} <= 0]?create)
exten => _9XX,n,Meetme(${CONF},ps)

exten => _9XX,n+1(create),Background(to-record-call&press-1&otherwise&press-0,m)
exten => _9XX,n,WaitExten(3)

exten => 0,1,Meetme(${CONF},1DpMaAs)

exten => 1,1,SET(CALLDATE=${IF(${EXISTS(${CALLDATE})}?${CALLDATE}:${STRFTIME(,,%Y-%m-%d)})})
exten => 1,n,SET(MEETME_RECORDINGFILE=/var/spool/asterisk/monitor/${CALLDATE}/${CONF}/${CDR(linkedid)}-1)
exten => 1,n,SET(MEETME_RECORDINGFORMAT=wav49)   
exten => 1,n,SET(MONITOR_EXEC_ARGS=${ODBC_RTDB(Setup,RecOpt)})
exten => 1,n,Monitor(${MEETME_RECORDINGFORMAT},${MEETME_RECORDINGFILE},m)
exten => 1,n,StopMonitor()
exten => 1,n,StopMixMonitor()
exten => 1,n,Meetme(${CONF},1DpMaAsr)

exten => t,1,Goto(0,1)
exten => i,1,Goto(${CONF},create)

[macro-vmdir]
exten => s,1,Macro(callergrp,${CALLERID(number)})
exten => s,n,Directory(6)
exten => s,n,Hangup

[ivredit]
exten => s,1,Macro(authuser,9)
exten => s,n,Macro(callergrp,${CALLERID(number)})
exten => s,n,SET(TIMEOUT(digit)=5)
exten => s,n,SET(TIMEOUT(response)=10)
exten => s,n(menu),BackGround(local/ivr-manage)

exten => 1,1,Wait(1)
exten => 1,n,Read(PHRASEID,local/ivr-select-msg)
exten => 1,n,Wait(3)
exten => 1,n,Record(custom/${PHRASEID}:gsm)
exten => 1,n,Wait(3)
exten => 1,n,Playback(custom/${PHRASEID})
exten => 1,n,Wait(1)
exten => 1,n,Goto(s,menu)

exten => 2,1,Wait(1)
exten => 2,n,Read(PHRASEID,local/ivr-select-msg)
exten => 2,n,Wait(1)
exten => 2,n,Playback(custom/${PHRASEID})
exten => 2,n,Wait(1)
exten => 2,n,Goto(s,menu)

exten => t,1,Hangup

exten => i,1,Playback(local/ivr-invalid)
exten => i,n,Goto(s,menu)

[macro-vmcol]
exten => s,1,Macro(callergrp,${ARG1})
exten => s,n,VoicemailMain(${ARG1}@6,s)
exten => s,n,Hangup

[macro-setcon]
exten => s,1,Macro(authuser,9)
exten => s,n,SET(ODBC_RTDB(${ARG1},${ARG2})=${ARG3})
exten => s,n,GotoIF($[${ARG2} = AUTHACCESS]?:result)
exten => s,n,SET(ACCESS=${ODBC_FEATDB(${ARG1},ACCESS)})
exten => s,n,SET(ACCESS=${IF(${EXISTS(${ACCESS})}?${ACCESS}:${ARG3})})
exten => s,n,GotoIF($[${ARG1} > ${ACCESS}]?:result)
exten => s,n,SET(ODBC_FEATDB(${ARG1},AUTHACCESS)=${ARG3})
exten => s,n(result),Background(extension)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Background(has-been-set-to)
exten => s,n,SayDigits(${ARG3})
exten => s,n,Hangup

[macro-setauth]
exten => s,1,Macro(authuser,${ARG1})
exten => s,n,Read(APASS,agent-pass,4)
exten => s,n,SayDigits(${APASS})
exten => s,n,SET(ODBC_SQL(password,users,mailbox,${ARG1})=${APASS})
exten => s,n,SET(ODBC_SQL(secret,users,mailbox,${ARG1})=${APASS})
exten => s,n,Hangup

[macro-intercom]
exten => s,1,Macro(authuser,${CALLERID(number)})
exten => s,n,Macro(callergrp,${CALLERID(number)})
exten => s,n,Dial(Console/dsp,,WgT)
exten => s,n,Goto(s-${DIALSTATUS},1)
exten => s,n,Hangup
exten => s-BUSY,1,BackGround(channel)
exten => s-BUSY,n,BackGround(is-curntly-unavail)
exten => s-BUSY,n,Hangup
exten => s-CHANUNAVAIL,1,Goto(s-BUSY,1)
exten => s-CONGESTION,1,Goto(s-BUSY,1)
exten => s-NOANSWER,1,Goto(s-BUSY,1)

[macro-musiconhold]
exten => s,1,Macro(callergrp,${CALLERID(number)})
exten => s,n,MusicOnHold()
exten => s,n,Hangup

[macro-mynumber]
exten => s,1,Macro(callergrp,${CALLERID(number)})
exten => s,n,SayDigits(${CALLERID(number)})
exten => s,n,Hangup

[macro-callwait]
exten => s,1,SET(WAIT=${ODBC_FEATDB(${CALLERID(number)},WAIT)})
exten => s,n,SET(WAIT=${IF(${EXISTS(${WAIT})}?${WAIT}:0)})
exten => s,n,GotoIf($[${WAIT} = 0]?deact)
exten => s,n,SET(ODBC_FEATDB(${CALLERID(number)},WAIT)=0)
exten => s,n,BackGround(activated)
exten => s,n,Hangup
exten => s,n(deact),SET(ODBC_FEATDB(${CALLERID(number)},WAIT)=1)
exten => s,n,BackGround(de-activated)
exten => s,n,Hangup

[macro-anstout]
exten => s,1,SET(ODBC_FEATDB(${CALLERID(number)},TOUT)=${ARG1})
exten => s,n,Background(extension)
exten => s,n,SayDigits(${CALLERID(number)})
exten => s,n,Background(has-been-set-to)
exten => s,n,SayDigits(${ARG1})
exten => s,n,Background(seconds)
exten => s,n,Hangup

[macro-echotest]
exten => s,1,Answer
exten => s,n,Macro(callergrp,${CALLERID(number)})
exten => s,n,Goto(${ARG1},1)

exten => 600,1,Playback(demo-echotest)
exten => 600,n,Echo
exten => 600,n,Playback(demo-echodone)
exten => 600,n,Hangup

exten => 601,1,Playback(demo-abouttotry)
exten => 601,n,Dial(IAX2/guest@misery.digium.com/s@default,,WgT)
exten => 601,n,Playback(demo-nogo)
exten => 601,n,Hangup

exten => 650,1,Dial(${PARENTDIAL}/600,,WgT)
exten => 650,n,Hangup

[macro-callrec]
exten => s,1,Macro(getacc,)
exten => s,n,SET(CLOGID=${IF(${EXISTS(${DDIUNIQUEID})}?${DDIUNIQUEID}:${CDR(linkedid)})})
exten => s,n,SET(CALLLEG=${ODBC_LOGCOUNT(${CLOGID})})
exten => s,n,SET(ODBC_LOG(${CLOGID},${CALLLEG},${CHANNEL})=${CALLERID(number)})
exten => s,n,SET(CALLDATE=${IF(${EXISTS(${CALLDATE})}?${CALLDATE}:${STRFTIME(,,%Y-%m-%d)})})
exten => s,n,SET(MONITOR_EXEC_ARGS=${ODBC_RTDB(Setup,RecOpt)})
exten => s,n,Monitor(wav49,/var/spool/asterisk/monitor/${CALLDATE}/${CALLERID(number)}/${CLOGID}-${CALLLEG},mb)
exten => s,n,Goto(userout,${ARG2},1)
exten => s,n,Hangup

[macro-roamauth]
exten => s,1,Answer
exten => s,n,Background(please-enter-your)
exten => s,n,Read(EXNUM,extension,4,,1,6)
exten => s,n,SET(ARRAY(UPASS,AUTHLEV)="${ODBC_FEATDB(${EXNUM},"roampass,authaccess")}")
exten => s,n,Background(please-enter-your)
exten => s,n,Read(EPASS,access-code,4,,1,6)
exten => s,n,GotoIF($[${UPASS} = ${EPASS}]?ok:deny)
exten => s,n+1(ok),Macro(callout,${ARG1},,${EXNUM},${AUTHLEV},${AUTHLEV})
exten => s,n+1(deny),Congestion(5)

[macro-enumlookup]
exten => s,1,Set(E164NETWORKS=e164.vbox.co.za-e164.arpa-e164.info-e164.org) 
exten => s,n(begin),GotoIf(${EXISTS(${E164NETWORKS})}?:failed)
exten => s,n,Set(ENUMNET=${CUT(E164NETWORKS,,1)})
exten => s,n,Set(E164NETWORKS=${CUT(E164NETWORKS,,2-)})
exten => s,n,Set(ENUMCOUNT=${ENUMLOOKUP(${ARG1},ALL,c,${ENUMNET})})
exten => s,n,GotoIf(${EXISTS(${ENUMCOUNT})}?:begin)
exten => s,n,GotoIf($[${ENUMCOUNT} = 0 ]?begin) 
exten => s,n,Set(ENUMPTR=1)
exten => s,n(startloop),Set(ENUM=${ENUMLOOKUP(${ARG1},ALL,${ENUMPTR},${ENUMNET})})
exten => s,n,GotoIf(${EXISTS(${ENUM})}?:continue)
exten => s,n,GotoIf($[${ENUM:0:3} = sip ]?sipuri)
exten => s,n,GotoIf($[${ENUM:0:3} = iax ]?iaxuri)
exten => s,n,GotoIf($[${ENUM:0:4} = iax2 ]?iax2uri) 
exten => s,n,GotoIf($[${ENUM:0:4} = h323 ]?h323uri)
exten => s,n(continue),Set(ENUMPTR=$[${ENUMPTR} + 1])
exten => s,n,GotoIf($[${ENUMPTR} > ${ENUMCOUNT}]?begin)
exten => s,n,Goto(startloop)
exten => s,n+1(sipuri),Set(DIALSTR=SIP/${ENUM:4})
exten => s,n,Goto(dodial)
exten => s,n(iaxuri),Set(DIALSTR=IAX2/${ENUM:4})
exten => s,n,Goto(dodial)
exten => s,n(h323uri),Set(DIALSTR=OOH323/${ENUM:5})
exten => s,n,Goto(dodial)
exten => s,n(iaxuri),Set(DIALSTR=IAX2/${ENUM:5})
exten => s,n(dodial),GotoIF($[${LEN(${CALLERID(number)})} != 7]?dialcli)
exten => s,n,SET(CALLERID(name)=011${CALLERID(number)})
exten => s,n(dialcli),Dial(${DIALSTR},,WgT)
exten => s,n,GotoIf($[${ENUMPTR} = ${ENUMCOUNT}]?noneleft)
exten => s,n,GotoIf($[${DIALSTATUS} != ANSWER ]?continue)
exten => s,n(noneleft),NoOp()
exten => s,n+1(failed),NoOp()


[macro-page]
exten => s,1(cavail),ChanIsAvail(SIP/${ARG1},js)
exten => s,n,SET(_VXML_URL=intercom=true)
exten => s,n,SIPAddHeader(Call-Info: sip:192.168.255.1\;answer-after=0)
exten => s,n,SET(_INTERCOM=true) 
exten => s,n,Dial(SIP/${ARG1})
exten => s,n,Hangup
exten => s,cavail+101,Hangup 

;exten => s,2,Set(_ALERT_INFO="RA") ; This is for the PolyComs
;exten => s,3,SIPAddHeader,Call-Info: sip:192.168.20.1/; answer-after=0
;exten => s,3,SIPAddHeader(Call-Info:<sip:domain>\;answer-after=0)   ; enter your domain

[macro-gtalk]
exten => s,1,SET(GTACC=${CUT(ARG1,"/",1)})
exten => s,n,SET(GTEXTEN=${CUT(ARG1,"/",2)})
exten => s,n,SET(GTUSER=${CUT(GTACC,"@",1)})
exten => s,n,SET(GTDOM=${CUT(GTACC,"@",2)})
exten => s,n,SET(GTDOM=${IF(${EXISTS(${GTDOM})}?${GTDOM}:gmail.com)})
exten => s,n,GotoIf(${EXISTS(${GTEXTEN})}?ddidial)
exten => s,n,Dial(Gtalk/gtalk/${GTACC}@${GTDOM},,WgT)
exten => s,n+1(ddidial),Dial(Gtalk/gtalk/${GTACC}@${GTDOM}/${GTEXTEN},,WgT)

[macro-callergrp]
exten => s,1,GotoIf(${EXISTS(${ARG1})}?:called)
exten => s,n,SET(GROUP(caller)=${ARG1})
exten => s,n(called),GotoIf(${EXISTS(${ARG2})}?:return)
exten => s,n,SET(GROUP(called)=${ARG2})
exten => s,n(return),NoOp()

[macro-ipnumber]
exten => s,1,Answer
exten => s,n,SayDigits(${CUT(ARG1,.,1)})
exten => s,n,Playback(dot)
exten => s,n,SayDigits(${CUT(ARG1,.,2)})
exten => s,n,Playback(dot)
exten => s,n,SayDigits(${CUT(ARG1,.,3)})
exten => s,n,Playback(dot)
exten => s,n,SayDigits(${CUT(ARG1,.,4)})
exten => s,n,Playback(vm-goodbye)
exten => s,n,Hangup

[macro-pickupfixup]
exten => s,1,SET(GROUP(called)=)
exten => s,n,SET(GROUP(qagent)=)

[macro-queueconnect]
exten => s,1,GotoIf($["${CUT(CHANNEL(name),-,1)}" != "${MEMBERINTERFACE}"]?checkrec)
exten => s,n,SET(GROUP(qagent)=${MEMBERNAME})
exten => s,n(checkrec),SET(AQUEUE=${ODBC_RTDB(Setup,AttendantQ)})
exten => s,n,SET(AQUEUE=${IF(${EXISTS(${AQUEUE})}?${AQUEUE}:799)})  
exten => s,n,SET(QUEUENAME=${IF(${EXISTS(${QUEUENAME})}?${QUEUENAME}:${AQUEUE})})
exten => s,n,GotoIf($[${AQUEUE} = ${QUEUENAME}]?autoa:queue)
exten => s,n,Hangup
exten => s,n+1(autoa),SET(AAREC=${ODBC_RTDB(Setup,AAREC)})
exten => s,n,SET(AAREC=${IF(${EXISTS(${AAREC})}?${AAREC}:0)})
exten => s,n,GotoIf(${AAREC}?record)
exten => s,n,Hangup
exten => s,n+1(queue),SET(QRECORD=${ODBC_QFEATDB(${QUEUENAME},record)})
exten => s,n,SET(QRECORD=${IF(${EXISTS(${QRECORD})}?${QRECORD}:0)})
exten => s,n,GotoIf(${QRECORD}?record)
exten => s,n+1(record),SET(CLOGID=${IF(${EXISTS(${DDIUNIQUEID})}?${DDIUNIQUEID}:${CDR(linkedid)})})
exten => s,n,SET(CALLLEG=${ODBC_LOGCOUNT(${CLOGID})})
exten => s,n,SET(ODBC_LOG(${CLOGID},${CALLLEG},${CHANNEL})=${MEMBERNAME})
exten => s,n,SET(CALLDATE=${IF(${EXISTS(${CALLDATE})}?${CALLDATE}:${STRFTIME(,,%Y-%m-%d)})})
exten => s,n,SET(MONITOR_EXEC_ARGS=${ODBC_RTDB(Setup,RecOpt)})
exten => s,n,Monitor(wav49,/var/spool/asterisk/monitor/${CALLDATE}/${MEMBERNAME}/${CLOGID}-${CALLLEG},mb)
exten => s,n,Hangup
